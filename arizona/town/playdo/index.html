<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plaidoyer Citoyen â€” Poste de Travail</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
:root {
    --bg: #0a0a0b;
    --bg-panel: #141417;
    --bg-card: #1c1c21;
    --bg-input: #252529;
    --border: #2e2e33;
    --border-light: #3a3a40;
    --text: #fafafa;
    --text-muted: #71717a;
    --accent: #f59e0b;
    --accent-dim: #b45309;
    --success: #22c55e;
    --danger: #ef4444;
    --info: #3b82f6;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: 'Inter', -apple-system, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.5;
    overflow: hidden;
}

.app {
    display: grid;
    grid-template-columns: 260px 1fr 380px;
    height: 100vh;
}

/* SIDEBAR */
.sidebar {
    background: var(--bg-panel);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.sidebar-header {
    padding: 1.25rem;
    border-bottom: 1px solid var(--border);
}

.logo {
    display: flex;
    align-items: center;
    gap: 0.6rem;
}

.logo-icon {
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, var(--accent), #ea580c);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
}

.logo-text {
    font-weight: 700;
    font-size: 0.95rem;
}

.projects-section {
    padding: 0.75rem;
    border-bottom: 1px solid var(--border);
}

.section-title {
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-muted);
    padding: 0.5rem 0.5rem 0.25rem;
}

.project-list {
    max-height: 200px;
    overflow-y: auto;
}

.project-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.6rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
    transition: background 0.15s;
}

.project-item:hover { background: var(--bg-card); }
.project-item.active { background: var(--accent-dim); color: white; }

.project-item-name {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.project-item-delete {
    opacity: 0;
    background: none;
    border: none;
    color: var(--danger);
    cursor: pointer;
    font-size: 0.8rem;
}

.project-item:hover .project-item-delete { opacity: 0.7; }
.project-item-delete:hover { opacity: 1 !important; }

.btn-new-project {
    width: 100%;
    padding: 0.5rem;
    margin-top: 0.5rem;
    background: var(--bg-card);
    border: 1px dashed var(--border-light);
    border-radius: 6px;
    color: var(--text-muted);
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.15s;
}

.btn-new-project:hover {
    background: var(--bg-input);
    color: var(--text);
    border-color: var(--accent);
}

.nav-section {
    flex: 1;
    overflow-y: auto;
    padding: 0.5rem;
}

.nav-group-title {
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-muted);
    padding: 0.75rem 0.5rem 0.25rem;
}

.nav-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.45rem 0.6rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.8rem;
    color: var(--text-muted);
    transition: all 0.15s;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
}

.nav-item:hover { background: var(--bg-card); color: var(--text); }
.nav-item.active { background: var(--bg-card); color: var(--accent); }

.sidebar-footer {
    padding: 0.75rem 1rem;
    border-top: 1px solid var(--border);
    font-size: 0.7rem;
    color: var(--text-muted);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.save-status { display: flex; align-items: center; gap: 0.4rem; }

.save-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--success);
}

.save-dot.saving {
    background: var(--accent);
    animation: pulse 1s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
}

/* EDITOR */
.editor {
    display: flex;
    flex-direction: column;
    overflow: hidden;
    background: var(--bg);
}

.editor-header {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: var(--bg-panel);
}

.editor-title { font-size: 1.1rem; font-weight: 600; }

.editor-content {
    flex: 1;
    overflow-y: auto;
    padding: 1.5rem;
}

.page { display: none; max-width: 800px; }
.page.active { display: block; animation: fadeIn 0.2s ease; }

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
}

.page-intro {
    color: var(--text-muted);
    font-size: 0.9rem;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border);
}

.card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 10px;
    margin-bottom: 1rem;
}

.card-header {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border);
    font-weight: 600;
    font-size: 0.9rem;
}

.card-body { padding: 1rem; }

.form-group { margin-bottom: 1rem; }
.form-group:last-child { margin-bottom: 0; }

.form-label {
    display: block;
    font-size: 0.8rem;
    font-weight: 500;
    margin-bottom: 0.4rem;
    color: var(--text-muted);
}

.form-input, .form-textarea, .form-select {
    width: 100%;
    padding: 0.6rem 0.8rem;
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-family: inherit;
    font-size: 0.9rem;
    transition: border-color 0.15s;
}

.form-input:focus, .form-textarea:focus, .form-select:focus {
    outline: none;
    border-color: var(--accent);
}

.form-textarea { min-height: 100px; resize: vertical; line-height: 1.6; }

.form-hint { font-size: 0.7rem; color: var(--text-muted); margin-top: 0.3rem; }

.form-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }

.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.4rem;
    padding: 0.5rem 1rem;
    font-family: inherit;
    font-size: 0.8rem;
    font-weight: 500;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    transition: all 0.15s;
}

.btn-primary { background: var(--accent); color: #000; }
.btn-primary:hover { background: var(--accent-dim); }
.btn-secondary { background: var(--bg-input); color: var(--text); border: 1px solid var(--border); }
.btn-secondary:hover { background: var(--bg-card); }
.btn-sm { padding: 0.35rem 0.7rem; font-size: 0.75rem; }

/* ACTORS */
.actor-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin-top: 1rem; }

.actor-column {
    background: var(--bg-input);
    border-radius: 8px;
    padding: 0.75rem;
    min-height: 150px;
}

.actor-column-title {
    font-size: 0.75rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border);
}

.actor-column.ally .actor-column-title { color: var(--success); }
.actor-column.neutral .actor-column-title { color: var(--text-muted); }
.actor-column.opponent .actor-column-title { color: var(--danger); }

.actor-chip {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.35rem 0.5rem;
    background: var(--bg-card);
    border-radius: 4px;
    font-size: 0.75rem;
    margin-bottom: 0.4rem;
}

.actor-chip-power { color: var(--accent); font-size: 0.65rem; }

.actor-chip-delete {
    margin-left: auto;
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    opacity: 0.5;
    font-size: 0.7rem;
}

.actor-chip-delete:hover { color: var(--danger); opacity: 1; }

/* SMART */
.smart-item {
    display: flex;
    align-items: flex-start;
    gap: 0.6rem;
    padding: 0.6rem;
    background: var(--bg-input);
    border-radius: 6px;
    margin-bottom: 0.5rem;
}

.smart-checkbox { margin-top: 0.2rem; }
.smart-content { flex: 1; }
.smart-text { font-size: 0.85rem; }
.smart-text.done { text-decoration: line-through; opacity: 0.6; }
.smart-meta { font-size: 0.7rem; color: var(--text-muted); margin-top: 0.2rem; }

/* JOURNAL */
.journal-entry {
    display: flex;
    gap: 0.75rem;
    padding: 0.75rem;
    background: var(--bg-input);
    border-radius: 6px;
    margin-bottom: 0.5rem;
}

.journal-icon { font-size: 1.2rem; }
.journal-content { flex: 1; }
.journal-text { font-size: 0.85rem; }
.journal-date { font-size: 0.7rem; color: var(--text-muted); margin-top: 0.2rem; }

/* PREVIEW */
.preview {
    background: var(--bg-panel);
    border-left: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.preview-header {
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--border);
    font-size: 0.9rem;
    font-weight: 600;
}

.preview-content {
    flex: 1;
    overflow-y: auto;
    padding: 1.25rem;
}

.preview-doc {
    background: #1a1a1f;
    border-radius: 8px;
    padding: 1.5rem;
    font-size: 0.85rem;
    line-height: 1.7;
}

.preview-doc h1 {
    font-size: 1.3rem;
    color: var(--accent);
    margin-bottom: 0.25rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid var(--border);
}

.preview-doc .doc-meta {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-bottom: 1.5rem;
}

.preview-doc h2 {
    font-size: 1rem;
    color: var(--info);
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
}

.preview-doc h3 {
    font-size: 0.9rem;
    color: var(--text);
    margin-top: 1rem;
    margin-bottom: 0.5rem;
}

.preview-doc p {
    margin-bottom: 0.75rem;
    color: var(--text-muted);
}

.preview-doc p.filled { color: var(--text); }
.preview-doc .empty { color: var(--text-muted); font-style: italic; opacity: 0.6; }

.preview-doc .actor-badge {
    display: inline-block;
    padding: 0.15rem 0.5rem;
    border-radius: 100px;
    font-size: 0.7rem;
    margin: 0.15rem;
}

.preview-doc .actor-badge.ally { background: rgba(34, 197, 94, 0.2); color: var(--success); }
.preview-doc .actor-badge.neutral { background: rgba(113, 113, 122, 0.2); color: var(--text-muted); }
.preview-doc .actor-badge.opponent { background: rgba(239, 68, 68, 0.2); color: var(--danger); }

.preview-actions {
    padding: 1rem 1.25rem;
    border-top: 1px solid var(--border);
    display: flex;
    gap: 0.5rem;
}

.preview-actions .btn { flex: 1; }

/* MODAL */
.modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-overlay.show { display: flex; }

.modal {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.5rem;
    width: 400px;
    max-width: 90vw;
}

.modal-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; }

.modal-actions {
    display: flex;
    gap: 0.5rem;
    justify-content: flex-end;
    margin-top: 1.5rem;
}

/* TOAST */
.toast-container {
    position: fixed;
    bottom: 1rem;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1001;
}

.toast {
    background: var(--bg-card);
    border: 1px solid var(--border);
    padding: 0.75rem 1.25rem;
    border-radius: 8px;
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    box-shadow: 0 10px 40px rgba(0,0,0,0.4);
    animation: toastIn 0.3s ease;
}

@keyframes toastIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--text-muted);
}

.empty-state-icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }
.empty-state-title { font-size: 1.1rem; font-weight: 600; color: var(--text); margin-bottom: 0.5rem; }
.empty-state-text { font-size: 0.85rem; margin-bottom: 1.5rem; }

@media (max-width: 1100px) {
    .app { grid-template-columns: 240px 1fr 300px; }
}

@media (max-width: 900px) {
    .app { grid-template-columns: 1fr; }
    .sidebar, .preview { display: none; }
}
    </style>
</head>
<body>

<div class="app">
    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <div class="logo-icon">âš–ï¸</div>
                <span class="logo-text">Plaidoyer Citoyen</span>
            </div>
        </div>
        
        <div class="projects-section">
            <div class="section-title">ğŸ“ Mes projets</div>
            <div class="project-list" id="project-list"></div>
            <button class="btn-new-project" onclick="createProject()">+ Nouveau projet</button>
        </div>
        
        <nav class="nav-section" id="nav-section">
            <div class="nav-group-title">ğŸ‘ï¸ VOIR</div>
            <button class="nav-item active" data-page="domino"><span>ğŸ¯</span> Vision (Domino)</button>
            <button class="nav-item" data-page="profil"><span>ğŸ‘¤</span> Profil citoyen</button>
            <button class="nav-item" data-page="fleur"><span>ğŸŒ¸</span> Fleur du pouvoir</button>
            
            <div class="nav-group-title">âš–ï¸ JUGER</div>
            <button class="nav-item" data-page="acteurs"><span>ğŸ‘¥</span> Acteurs</button>
            <button class="nav-item" data-page="arbre"><span>ğŸŒ³</span> Arbre Ã  problÃ¨mes</button>
            <button class="nav-item" data-page="swot"><span>ğŸ“Š</span> SWOT</button>
            <button class="nav-item" data-page="pestel"><span>ğŸŒ</span> PESTEL</button>
            <button class="nav-item" data-page="tdc"><span>ğŸ”„</span> ThÃ©orie du changement</button>
            
            <div class="nav-group-title">âœŠ AGIR</div>
            <button class="nav-item" data-page="cibles"><span>ğŸ¯</span> Cibles & AlliÃ©s</button>
            <button class="nav-item" data-page="smart"><span>ğŸ“‹</span> Objectifs SMART</button>
            <button class="nav-item" data-page="message"><span>ğŸ’¬</span> Message clÃ©</button>
            <button class="nav-item" data-page="journal"><span>ğŸ““</span> Journal de bord</button>
        </nav>
        
        <div class="sidebar-footer">
            <div class="save-status">
                <span class="save-dot" id="save-dot"></span>
                <span id="save-text">SauvegardÃ©</span>
            </div>
            <span id="storage-info">--</span>
        </div>
    </aside>
    
    <!-- EDITOR -->
    <main class="editor">
        <header class="editor-header">
            <h1 class="editor-title" id="editor-title">Vision (Domino)</h1>
        </header>
        
        <div class="editor-content" id="editor-content">
            <!-- EMPTY STATE -->
            <div class="page active" id="page-empty">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“‚</div>
                    <div class="empty-state-title">Aucun projet sÃ©lectionnÃ©</div>
                    <div class="empty-state-text">CrÃ©ez un nouveau projet ou sÃ©lectionnez-en un existant</div>
                    <button class="btn btn-primary" onclick="createProject()">+ CrÃ©er un projet</button>
                </div>
            </div>
            
            <!-- DOMINO -->
            <div class="page" id="page-domino">
                <p class="page-intro">Clarifiez votre vision du changement : quels obstacles surmonter, quelles ressources mobiliser.</p>
                <div class="card">
                    <div class="card-header">ğŸ¯ Vision du changement</div>
                    <div class="card-body">
                        <textarea class="form-textarea" data-field="domino.vision" rows="4" placeholder="DÃ©crivez le changement que vous souhaitez voir advenir..."></textarea>
                    </div>
                </div>
                <div class="form-row">
                    <div class="card">
                        <div class="card-header">ğŸš§ Obstacles</div>
                        <div class="card-body">
                            <textarea class="form-textarea" data-field="domino.obstacles" rows="5" placeholder="Obstacles politiques, administratifs, culturels..."></textarea>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">ğŸ’ª Ressources</div>
                        <div class="card-body">
                            <textarea class="form-textarea" data-field="domino.ressources" rows="5" placeholder="RÃ©seaux, expertise, lÃ©gitimitÃ©..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- PROFIL -->
            <div class="page" id="page-profil">
                <p class="page-intro">DÃ©finissez votre profil citoyen : motivations, compÃ©tences, disponibilitÃ©s.</p>
                <div class="form-row">
                    <div class="card"><div class="card-header">â¤ï¸ Motivations</div><div class="card-body"><textarea class="form-textarea" data-field="profil.motivations" rows="4" placeholder="Pourquoi vous engagez-vous ?"></textarea></div></div>
                    <div class="card"><div class="card-header">ğŸ› ï¸ CompÃ©tences</div><div class="card-body"><textarea class="form-textarea" data-field="profil.competences" rows="4" placeholder="Analyse, communication..."></textarea></div></div>
                </div>
                <div class="form-row">
                    <div class="card"><div class="card-header">â° Temps disponible</div><div class="card-body"><textarea class="form-textarea" data-field="profil.temps" rows="4" placeholder="DisponibilitÃ©s..."></textarea></div></div>
                    <div class="card"><div class="card-header">âš ï¸ Limites</div><div class="card-body"><textarea class="form-textarea" data-field="profil.limites" rows="4" placeholder="Contraintes, lignes rouges..."></textarea></div></div>
                </div>
            </div>
            
            <!-- FLEUR -->
            <div class="page" id="page-fleur">
                <p class="page-intro">Analysez les rapports de pouvoir et de privilÃ¨ge.</p>
                <div class="card"><div class="card-header">ğŸ‘¥ Personnes concernÃ©es</div><div class="card-body"><textarea class="form-textarea" data-field="fleur.identites" rows="3" placeholder="Profils des personnes touchÃ©es..."></textarea></div></div>
                <div class="form-row">
                    <div class="card"><div class="card-header" style="color:var(--success)">âœ… PrivilÃ¨ges relatifs</div><div class="card-body"><textarea class="form-textarea" data-field="fleur.privileges" rows="4" placeholder="AccÃ¨s Ã  l'information, capital social..."></textarea></div></div>
                    <div class="card"><div class="card-header" style="color:var(--danger)">ğŸ¯ Oppressions subies</div><div class="card-body"><textarea class="form-textarea" data-field="fleur.oppressions" rows="4" placeholder="Discriminations, violences..."></textarea></div></div>
                </div>
            </div>
            
            <!-- ACTEURS -->
            <div class="page" id="page-acteurs">
                <p class="page-intro">Cartographiez les acteurs clÃ©s : dÃ©cideurs, alliÃ©s, opposants.</p>
                <div class="card">
                    <div class="card-header">â• Ajouter un acteur</div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group"><label class="form-label">Nom</label><input type="text" class="form-input" id="actor-name" placeholder="Nom"></div>
                            <div class="form-group"><label class="form-label">RÃ´le</label><input type="text" class="form-input" id="actor-role" placeholder="Fonction..."></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label class="form-label">Position</label><select class="form-select" id="actor-position"><option value="ally">ğŸŸ¢ AlliÃ©</option><option value="neutral">ğŸŸ¡ Neutre</option><option value="opponent">ğŸ”´ Opposant</option></select></div>
                            <div class="form-group"><label class="form-label">Pouvoir</label><select class="form-select" id="actor-power"><option value="1">1 â˜…</option><option value="2">2 â˜…â˜…</option><option value="3" selected>3 â˜…â˜…â˜…</option><option value="4">4 â˜…â˜…â˜…â˜…</option><option value="5">5 â˜…â˜…â˜…â˜…â˜…</option></select></div>
                        </div>
                        <button class="btn btn-primary" onclick="addActor()">Ajouter</button>
                    </div>
                </div>
                <div class="actor-grid">
                    <div class="actor-column ally"><div class="actor-column-title">ğŸŸ¢ AlliÃ©s</div><div id="actors-ally"></div></div>
                    <div class="actor-column neutral"><div class="actor-column-title">ğŸŸ¡ Neutres</div><div id="actors-neutral"></div></div>
                    <div class="actor-column opponent"><div class="actor-column-title">ğŸ”´ Opposants</div><div id="actors-opponent"></div></div>
                </div>
            </div>
            
            <!-- ARBRE -->
            <div class="page" id="page-arbre">
                <p class="page-intro">Identifiez le problÃ¨me central, ses causes et ses effets.</p>
                <div class="card"><div class="card-header">ğŸ¯ ProblÃ¨me central</div><div class="card-body"><textarea class="form-textarea" data-field="arbre.probleme" rows="2" placeholder="Quel est le problÃ¨me ?"></textarea></div></div>
                <div class="form-row">
                    <div class="card"><div class="card-header">ğŸŒ± Causes</div><div class="card-body"><textarea class="form-textarea" data-field="arbre.causes" rows="5" placeholder="Une cause par ligne..."></textarea><p class="form-hint">Une cause par ligne</p></div></div>
                    <div class="card"><div class="card-header">ğŸƒ Effets</div><div class="card-body"><textarea class="form-textarea" data-field="arbre.effets" rows="5" placeholder="Un effet par ligne..."></textarea><p class="form-hint">Un effet par ligne</p></div></div>
                </div>
            </div>
            
            <!-- SWOT -->
            <div class="page" id="page-swot">
                <p class="page-intro">Analysez vos Forces, Faiblesses, OpportunitÃ©s et Menaces.</p>
                <div class="form-row">
                    <div class="card"><div class="card-header" style="color:var(--success)">ğŸ’ª Forces</div><div class="card-body"><textarea class="form-textarea" data-field="swot.forces" rows="4" placeholder="Atouts internes..."></textarea></div></div>
                    <div class="card"><div class="card-header" style="color:var(--danger)">ğŸ˜° Faiblesses</div><div class="card-body"><textarea class="form-textarea" data-field="swot.faiblesses" rows="4" placeholder="Limites internes..."></textarea></div></div>
                </div>
                <div class="form-row">
                    <div class="card"><div class="card-header" style="color:var(--info)">ğŸŒŸ OpportunitÃ©s</div><div class="card-body"><textarea class="form-textarea" data-field="swot.opportunites" rows="4" placeholder="Facteurs favorables..."></textarea></div></div>
                    <div class="card"><div class="card-header" style="color:var(--accent)">âš ï¸ Menaces</div><div class="card-body"><textarea class="form-textarea" data-field="swot.menaces" rows="4" placeholder="Facteurs dÃ©favorables..."></textarea></div></div>
                </div>
            </div>
            
            <!-- PESTEL -->
            <div class="page" id="page-pestel">
                <p class="page-intro">Analysez le macro-environnement.</p>
                <div class="form-row">
                    <div class="card"><div class="card-header">ğŸ›ï¸ Politique</div><div class="card-body"><textarea class="form-textarea" data-field="pestel.politique" rows="3" placeholder="Gouvernance, Ã©lections..."></textarea></div></div>
                    <div class="card"><div class="card-header">ğŸ’¶ Ã‰conomique</div><div class="card-body"><textarea class="form-textarea" data-field="pestel.economique" rows="3" placeholder="Conjoncture, budgets..."></textarea></div></div>
                </div>
                <div class="form-row">
                    <div class="card"><div class="card-header">ğŸ‘¥ Social</div><div class="card-body"><textarea class="form-textarea" data-field="pestel.social" rows="3" placeholder="Tendances sociales..."></textarea></div></div>
                    <div class="card"><div class="card-header">ğŸ’» Technologique</div><div class="card-body"><textarea class="form-textarea" data-field="pestel.technologique" rows="3" placeholder="Innovations..."></textarea></div></div>
                </div>
                <div class="form-row">
                    <div class="card"><div class="card-header">ğŸŒ± Environnemental</div><div class="card-body"><textarea class="form-textarea" data-field="pestel.environnemental" rows="3" placeholder="Enjeux Ã©cologiques..."></textarea></div></div>
                    <div class="card"><div class="card-header">âš–ï¸ LÃ©gal</div><div class="card-body"><textarea class="form-textarea" data-field="pestel.legal" rows="3" placeholder="Cadre juridique..."></textarea></div></div>
                </div>
            </div>
            
            <!-- TDC -->
            <div class="page" id="page-tdc">
                <p class="page-intro">Articulez vos hypothÃ¨ses sur comment le changement se produit.</p>
                <div class="card"><div class="card-header">ğŸ¯ Impact final visÃ©</div><div class="card-body"><textarea class="form-textarea" data-field="tdc.impact" rows="2" placeholder="Changement ultime visÃ©..."></textarea></div></div>
                <div class="form-row">
                    <div class="card"><div class="card-header">ğŸ”¹ Individuel interne</div><div class="card-body"><textarea class="form-textarea" data-field="tdc.individuel_interne" rows="3" placeholder="Connaissances, attitudes..."></textarea></div></div>
                    <div class="card"><div class="card-header">ğŸ”¹ Individuel externe</div><div class="card-body"><textarea class="form-textarea" data-field="tdc.individuel_externe" rows="3" placeholder="Comportements..."></textarea></div></div>
                </div>
                <div class="form-row">
                    <div class="card"><div class="card-header">ğŸ”¸ Collectif interne</div><div class="card-body"><textarea class="form-textarea" data-field="tdc.collectif_interne" rows="3" placeholder="Culture, normes..."></textarea></div></div>
                    <div class="card"><div class="card-header">ğŸ”¸ Collectif externe</div><div class="card-body"><textarea class="form-textarea" data-field="tdc.collectif_externe" rows="3" placeholder="Politiques, lois..."></textarea></div></div>
                </div>
            </div>
            
            <!-- CIBLES -->
            <div class="page" id="page-cibles">
                <p class="page-intro">Identifiez vos cibles et alliÃ©s stratÃ©giques.</p>
                <div class="form-row">
                    <div class="card"><div class="card-header">ğŸ¯ Cible principale</div><div class="card-body"><textarea class="form-textarea" data-field="cibles.principale" rows="3" placeholder="Qui dÃ©cide ?"></textarea></div></div>
                    <div class="card"><div class="card-header">ğŸ¯ Cibles secondaires</div><div class="card-body"><textarea class="form-textarea" data-field="cibles.secondaires" rows="3" placeholder="Qui influence ?"></textarea></div></div>
                </div>
                <div class="form-row">
                    <div class="card"><div class="card-header" style="color:var(--success)">ğŸ¤ AlliÃ©s</div><div class="card-body"><textarea class="form-textarea" data-field="cibles.allies" rows="3" placeholder="Organisations, rÃ©seaux..."></textarea></div></div>
                    <div class="card"><div class="card-header" style="color:var(--danger)">âš”ï¸ Opposants</div><div class="card-body"><textarea class="form-textarea" data-field="cibles.opposants" rows="3" placeholder="Qui s'oppose ?"></textarea></div></div>
                </div>
            </div>
            
            <!-- SMART -->
            <div class="page" id="page-smart">
                <p class="page-intro">DÃ©finissez des objectifs SpÃ©cifiques, Mesurables, Atteignables, RÃ©alistes, Temporels.</p>
                <div class="card">
                    <div class="card-header">â• Nouvel objectif</div>
                    <div class="card-body">
                        <div class="form-group"><textarea class="form-textarea" id="smart-text" rows="2" placeholder="Ex: Obtenir 50 000 signatures d'ici le 1er mars"></textarea></div>
                        <div class="form-row">
                            <div class="form-group"><label class="form-label">Indicateur</label><input type="text" class="form-input" id="smart-indicator" placeholder="Ex: Nombre de signatures"></div>
                            <div class="form-group"><label class="form-label">Ã‰chÃ©ance</label><input type="date" class="form-input" id="smart-deadline"></div>
                        </div>
                        <button class="btn btn-primary" onclick="addSmart()">Ajouter</button>
                    </div>
                </div>
                <div class="card"><div class="card-header">ğŸ“‹ Objectifs</div><div class="card-body" id="smart-list"><p style="color:var(--text-muted);text-align:center;font-size:0.85rem">Aucun objectif</p></div></div>
            </div>
            
            <!-- MESSAGE -->
            <div class="page" id="page-message">
                <p class="page-intro">Construisez votre message de plaidoyer.</p>
                <div class="card">
                    <div class="card-header">ğŸ’¬ Construction du message</div>
                    <div class="card-body">
                        <div class="form-group"><label class="form-label">ğŸ£ Accroche</label><textarea class="form-textarea" data-field="message.accroche" rows="2" placeholder="Phrase percutante..."></textarea></div>
                        <div class="form-group"><label class="form-label">â— ProblÃ¨me</label><textarea class="form-textarea" data-field="message.probleme" rows="2" placeholder="DÃ©crivez le problÃ¨me..."></textarea></div>
                        <div class="form-group"><label class="form-label">âš¡ Importance</label><textarea class="form-textarea" data-field="message.importance" rows="2" placeholder="Pourquoi agir ?"></textarea></div>
                        <div class="form-group"><label class="form-label">ğŸ‘‰ Appel Ã  l'action</label><textarea class="form-textarea" data-field="message.action" rows="2" placeholder="Que demandez-vous ?"></textarea></div>
                    </div>
                </div>
            </div>
            
            <!-- JOURNAL -->
            <div class="page" id="page-journal">
                <p class="page-intro">Tenez un journal de vos actions et rencontres.</p>
                <div class="card">
                    <div class="card-header">â• Nouvelle entrÃ©e</div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group"><label class="form-label">Date</label><input type="date" class="form-input" id="journal-date"></div>
                            <div class="form-group"><label class="form-label">Type</label><select class="form-select" id="journal-type"><option value="action">ğŸ¯ Action</option><option value="rencontre">ğŸ¤ Rencontre</option><option value="victoire">ğŸ† Victoire</option><option value="difficulte">âš ï¸ DifficultÃ©</option><option value="note">ğŸ“ Note</option></select></div>
                        </div>
                        <div class="form-group"><textarea class="form-textarea" id="journal-content" rows="2" placeholder="DÃ©crivez..."></textarea></div>
                        <button class="btn btn-primary" onclick="addJournal()">Ajouter</button>
                    </div>
                </div>
                <div class="card"><div class="card-header">ğŸ““ Historique</div><div class="card-body" id="journal-list"><p style="color:var(--text-muted);text-align:center;font-size:0.85rem">Aucune entrÃ©e</p></div></div>
            </div>
        </div>
    </main>
    
    <!-- PREVIEW -->
    <aside class="preview">
        <header class="preview-header">ğŸ‘ï¸ AperÃ§u en direct</header>
        <div class="preview-content"><div class="preview-doc" id="preview-doc"></div></div>
        <div class="preview-actions">
            <button class="btn btn-secondary" onclick="exportJSON()">ğŸ“„ JSON</button>
            <button class="btn btn-secondary" onclick="exportMD()">ğŸ“ MD</button>
            <button class="btn btn-primary" onclick="exportPDF()">ğŸ“• PDF</button>
        </div>
    </aside>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modal">
    <div class="modal">
        <h2 class="modal-title">Nouveau projet</h2>
        <div class="form-group"><label class="form-label">Nom du projet</label><input type="text" class="form-input" id="new-project-name" placeholder="Ex: Campagne Stop Arizona"></div>
        <div class="form-group"><label class="form-label">Description</label><textarea class="form-textarea" id="new-project-desc" rows="2" placeholder="Description courte..."></textarea></div>
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeModal()">Annuler</button>
            <button class="btn btn-primary" onclick="confirmCreate()">CrÃ©er</button>
        </div>
    </div>
</div>

<div class="toast-container" id="toast-container"></div>

<script>
const DB_NAME = 'PlaidoyerDB', DB_VERSION = 1;
let db, currentId = null, current = null, saveTimer = null;

async function initDB() {
    return new Promise((res, rej) => {
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        req.onerror = () => rej(req.error);
        req.onsuccess = () => { db = req.result; res(db); };
        req.onupgradeneeded = e => {
            if (!e.target.result.objectStoreNames.contains('projects'))
                e.target.result.createObjectStore('projects', { keyPath: 'id' });
        };
    });
}

async function dbSave(p) {
    return new Promise((res, rej) => {
        const tx = db.transaction('projects', 'readwrite');
        const req = tx.objectStore('projects').put(p);
        req.onsuccess = () => res();
        req.onerror = () => rej(req.error);
    });
}

async function dbGet(id) {
    return new Promise((res, rej) => {
        const req = db.transaction('projects').objectStore('projects').get(id);
        req.onsuccess = () => res(req.result);
        req.onerror = () => rej(req.error);
    });
}

async function dbAll() {
    return new Promise((res, rej) => {
        const req = db.transaction('projects').objectStore('projects').getAll();
        req.onsuccess = () => res(req.result || []);
        req.onerror = () => rej(req.error);
    });
}

async function dbDel(id) {
    return new Promise((res, rej) => {
        const req = db.transaction('projects', 'readwrite').objectStore('projects').delete(id);
        req.onsuccess = () => res();
        req.onerror = () => rej(req.error);
    });
}

function newProject(name, desc = '') {
    return {
        id: Date.now().toString(), name, description: desc,
        created: new Date().toISOString(), modified: new Date().toISOString(),
        domino: { vision: '', obstacles: '', ressources: '' },
        profil: { motivations: '', competences: '', temps: '', limites: '' },
        fleur: { identites: '', privileges: '', oppressions: '' },
        acteurs: [],
        arbre: { probleme: '', causes: '', effets: '' },
        swot: { forces: '', faiblesses: '', opportunites: '', menaces: '' },
        pestel: { politique: '', economique: '', social: '', technologique: '', environnemental: '', legal: '' },
        tdc: { impact: '', individuel_interne: '', individuel_externe: '', collectif_interne: '', collectif_externe: '' },
        cibles: { principale: '', secondaires: '', allies: '', opposants: '' },
        smart: [], message: { accroche: '', probleme: '', importance: '', action: '' }, journal: []
    };
}

document.addEventListener('DOMContentLoaded', async () => {
    await initDB();
    await renderList();
    initNav();
    initAutoSave();
    document.getElementById('journal-date').value = new Date().toISOString().split('T')[0];
});

function initNav() {
    document.querySelectorAll('.nav-item').forEach(el => {
        el.addEventListener('click', () => {
            if (!currentId) { toast('SÃ©lectionnez un projet', 'warning'); return; }
            showPage(el.dataset.page);
        });
    });
}

function initAutoSave() {
    document.querySelectorAll('[data-field]').forEach(el => {
        el.addEventListener('input', () => {
            if (!current) return;
            const [a, b] = el.dataset.field.split('.');
            current[a][b] = el.value;
            scheduleSave();
            updatePreview();
        });
    });
}

function scheduleSave() {
    document.getElementById('save-dot').classList.add('saving');
    document.getElementById('save-text').textContent = 'Sauvegarde...';
    clearTimeout(saveTimer);
    saveTimer = setTimeout(async () => {
        if (current) {
            current.modified = new Date().toISOString();
            await dbSave(current);
            document.getElementById('save-dot').classList.remove('saving');
            document.getElementById('save-text').textContent = 'SauvegardÃ©';
        }
    }, 400);
}

async function renderList() {
    const list = await dbAll();
    const el = document.getElementById('project-list');
    if (!list.length) { el.innerHTML = '<p style="color:var(--text-muted);font-size:0.8rem;padding:0.5rem;text-align:center">Aucun projet</p>'; return; }
    el.innerHTML = list.map(p => `
        <div class="project-item ${p.id === currentId ? 'active' : ''}" onclick="selectProject('${p.id}')">
            <span>ğŸ“</span>
            <span class="project-item-name">${esc(p.name)}</span>
            <button class="project-item-delete" onclick="event.stopPropagation();delProject('${p.id}')" title="Supprimer">âœ•</button>
        </div>
    `).join('');
}

function createProject() { document.getElementById('modal').classList.add('show'); document.getElementById('new-project-name').focus(); }
function closeModal() { document.getElementById('modal').classList.remove('show'); document.getElementById('new-project-name').value = ''; document.getElementById('new-project-desc').value = ''; }

async function confirmCreate() {
    const name = document.getElementById('new-project-name').value.trim();
    const desc = document.getElementById('new-project-desc').value.trim();
    if (!name) { toast('Entrez un nom', 'error'); return; }
    const p = newProject(name, desc);
    await dbSave(p);
    closeModal();
    await renderList();
    await selectProject(p.id);
    toast('Projet crÃ©Ã©', 'success');
}

async function selectProject(id) {
    currentId = id;
    current = await dbGet(id);
    await renderList();
    populate();
    renderActors();
    renderSmart();
    renderJournal();
    updatePreview();
    showPage('domino');
}

async function delProject(id) {
    if (!confirm('Supprimer ce projet ?')) return;
    await dbDel(id);
    if (currentId === id) { currentId = null; current = null; showPage('empty'); document.getElementById('preview-doc').innerHTML = ''; }
    await renderList();
    toast('Projet supprimÃ©', 'success');
}

function populate() {
    document.querySelectorAll('[data-field]').forEach(el => {
        const [a, b] = el.dataset.field.split('.');
        el.value = current?.[a]?.[b] || '';
    });
}

function showPage(id) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(`page-${id}`)?.classList.add('active');
    document.querySelectorAll('.nav-item').forEach(el => el.classList.toggle('active', el.dataset.page === id));
    const titles = { empty:'Bienvenue', domino:'Vision (Domino)', profil:'Profil citoyen', fleur:'Fleur du pouvoir', acteurs:'Acteurs', arbre:'Arbre Ã  problÃ¨mes', swot:'SWOT', pestel:'PESTEL', tdc:'ThÃ©orie du changement', cibles:'Cibles & AlliÃ©s', smart:'Objectifs SMART', message:'Message clÃ©', journal:'Journal de bord' };
    document.getElementById('editor-title').textContent = titles[id] || id;
}

function addActor() {
    if (!current) return;
    const name = document.getElementById('actor-name').value.trim();
    const role = document.getElementById('actor-role').value.trim();
    const position = document.getElementById('actor-position').value;
    const power = +document.getElementById('actor-power').value;
    if (!name) { toast('Entrez un nom', 'error'); return; }
    current.acteurs.push({ id: Date.now(), name, role, position, power });
    renderActors(); scheduleSave(); updatePreview();
    document.getElementById('actor-name').value = '';
    document.getElementById('actor-role').value = '';
    toast('Acteur ajoutÃ©', 'success');
}

function removeActor(id) {
    if (!current) return;
    current.acteurs = current.acteurs.filter(a => a.id !== id);
    renderActors(); scheduleSave(); updatePreview();
}

function renderActors() {
    if (!current) return;
    ['ally', 'neutral', 'opponent'].forEach(pos => {
        const c = document.getElementById(`actors-${pos}`);
        const actors = current.acteurs.filter(a => a.position === pos);
        c.innerHTML = actors.length ? actors.map(a => `
            <div class="actor-chip">
                <span>${esc(a.name)}</span>
                <span class="actor-chip-power">${'â˜…'.repeat(a.power)}</span>
                <button class="actor-chip-delete" onclick="removeActor(${a.id})">âœ•</button>
            </div>
        `).join('') : '<p style="color:var(--text-muted);font-size:0.75rem;text-align:center">â€”</p>';
    });
}

function addSmart() {
    if (!current) return;
    const text = document.getElementById('smart-text').value.trim();
    const indicator = document.getElementById('smart-indicator').value.trim();
    const deadline = document.getElementById('smart-deadline').value;
    if (!text) { toast('DÃ©crivez l\'objectif', 'error'); return; }
    current.smart.push({ id: Date.now(), text, indicator, deadline, done: false });
    renderSmart(); scheduleSave(); updatePreview();
    document.getElementById('smart-text').value = '';
    document.getElementById('smart-indicator').value = '';
    document.getElementById('smart-deadline').value = '';
    toast('Objectif ajoutÃ©', 'success');
}

function toggleSmart(id) { if (!current) return; const s = current.smart.find(x => x.id === id); if (s) s.done = !s.done; renderSmart(); scheduleSave(); updatePreview(); }
function removeSmart(id) { if (!current) return; current.smart = current.smart.filter(x => x.id !== id); renderSmart(); scheduleSave(); updatePreview(); }

function renderSmart() {
    if (!current) return;
    const c = document.getElementById('smart-list');
    if (!current.smart.length) { c.innerHTML = '<p style="color:var(--text-muted);text-align:center;font-size:0.85rem">Aucun objectif</p>'; return; }
    c.innerHTML = current.smart.map(s => `
        <div class="smart-item">
            <input type="checkbox" class="smart-checkbox" ${s.done ? 'checked' : ''} onchange="toggleSmart(${s.id})">
            <div class="smart-content">
                <div class="smart-text ${s.done ? 'done' : ''}">${esc(s.text)}</div>
                <div class="smart-meta">${s.indicator ? 'ğŸ“Š ' + esc(s.indicator) : ''} ${s.deadline ? 'ğŸ“… ' + s.deadline : ''}</div>
            </div>
            <button class="btn btn-sm btn-secondary" onclick="removeSmart(${s.id})">âœ•</button>
        </div>
    `).join('');
}

function addJournal() {
    if (!current) return;
    const date = document.getElementById('journal-date').value;
    const type = document.getElementById('journal-type').value;
    const content = document.getElementById('journal-content').value.trim();
    if (!content) { toast('DÃ©crivez l\'entrÃ©e', 'error'); return; }
    current.journal.unshift({ id: Date.now(), date, type, content });
    renderJournal(); scheduleSave(); updatePreview();
    document.getElementById('journal-content').value = '';
    toast('EntrÃ©e ajoutÃ©e', 'success');
}

function removeJournal(id) { if (!current) return; current.journal = current.journal.filter(x => x.id !== id); renderJournal(); scheduleSave(); updatePreview(); }

function renderJournal() {
    if (!current) return;
    const c = document.getElementById('journal-list');
    const icons = { action:'ğŸ¯', rencontre:'ğŸ¤', victoire:'ğŸ†', difficulte:'âš ï¸', note:'ğŸ“' };
    if (!current.journal.length) { c.innerHTML = '<p style="color:var(--text-muted);text-align:center;font-size:0.85rem">Aucune entrÃ©e</p>'; return; }
    c.innerHTML = current.journal.map(j => `
        <div class="journal-entry">
            <span class="journal-icon">${icons[j.type] || 'ğŸ“'}</span>
            <div class="journal-content">
                <div class="journal-text">${esc(j.content)}</div>
                <div class="journal-date">${j.date}</div>
            </div>
            <button class="btn btn-sm btn-secondary" onclick="removeJournal(${j.id})">âœ•</button>
        </div>
    `).join('');
}

function updatePreview() {
    if (!current) { document.getElementById('preview-doc').innerHTML = '<p style="color:var(--text-muted);text-align:center">Aucun projet</p>'; return; }
    const p = current;
    const f = v => v ? `<p class="filled">${esc(v)}</p>` : '<p class="empty">Non renseignÃ©</p>';
    let h = `<h1>${esc(p.name)}</h1><div class="doc-meta">${p.description ? esc(p.description) + ' â€” ' : ''}ModifiÃ© le ${new Date(p.modified).toLocaleDateString('fr-FR')}</div>`;
    h += `<h2>ğŸ‘ï¸ VOIR</h2><h3>ğŸ¯ Vision</h3>${f(p.domino.vision)}<h3>ğŸš§ Obstacles</h3>${f(p.domino.obstacles)}<h3>ğŸ’ª Ressources</h3>${f(p.domino.ressources)}`;
    h += `<h2>âš–ï¸ JUGER</h2><h3>ğŸŒ³ ProblÃ¨me</h3>${f(p.arbre.probleme)}`;
    if (p.acteurs.length) { h += '<h3>ğŸ‘¥ Acteurs</h3><p>'; p.acteurs.forEach(a => h += `<span class="actor-badge ${a.position}">${esc(a.name)}</span>`); h += '</p>'; }
    h += `<h3>ğŸ“Š SWOT</h3><p><strong>Forces:</strong> ${p.swot.forces || 'â€”'}</p><p><strong>Faiblesses:</strong> ${p.swot.faiblesses || 'â€”'}</p><p><strong>OpportunitÃ©s:</strong> ${p.swot.opportunites || 'â€”'}</p><p><strong>Menaces:</strong> ${p.swot.menaces || 'â€”'}</p>`;
    h += `<h2>âœŠ AGIR</h2><h3>ğŸ’¬ Message</h3>`;
    if (p.message.accroche) h += `<p class="filled"><strong>${esc(p.message.accroche)}</strong></p>`;
    if (p.message.probleme) h += `<p class="filled">${esc(p.message.probleme)}</p>`;
    if (p.message.importance) h += `<p class="filled"><em>${esc(p.message.importance)}</em></p>`;
    if (p.message.action) h += `<p class="filled"><strong>â†’ ${esc(p.message.action)}</strong></p>`;
    if (!p.message.accroche && !p.message.probleme && !p.message.action) h += '<p class="empty">Non renseignÃ©</p>';
    if (p.smart.length) { h += '<h3>ğŸ“‹ Objectifs</h3><ul>'; p.smart.forEach(s => h += `<li style="${s.done ? 'text-decoration:line-through;opacity:0.6' : ''}">${esc(s.text)}</li>`); h += '</ul>'; }
    document.getElementById('preview-doc').innerHTML = h;
}

function exportJSON() {
    if (!current) return;
    dl(JSON.stringify(current, null, 2), `${slug(current.name)}.json`, 'application/json');
    toast('Export JSON OK', 'success');
}

function exportMD() {
    if (!current) return;
    const p = current;
    let md = `# ${p.name}\n\n*${p.description || ''} â€” ${new Date().toLocaleDateString('fr-FR')}*\n\n---\n\n`;
    md += `## ğŸ‘ï¸ VOIR\n\n### Vision\n${p.domino.vision || '*â€”*'}\n\n### Obstacles\n${p.domino.obstacles || '*â€”*'}\n\n### Ressources\n${p.domino.ressources || '*â€”*'}\n\n`;
    md += `## âš–ï¸ JUGER\n\n### ProblÃ¨me\n${p.arbre.probleme || '*â€”*'}\n\n`;
    if (p.acteurs.length) { md += '### Acteurs\n'; p.acteurs.forEach(a => md += `- ${a.position === 'ally' ? 'ğŸŸ¢' : a.position === 'opponent' ? 'ğŸ”´' : 'ğŸŸ¡'} **${a.name}** (${a.role})\n`); md += '\n'; }
    md += `### SWOT\n| Forces | Faiblesses |\n|---|---|\n| ${p.swot.forces || 'â€”'} | ${p.swot.faiblesses || 'â€”'} |\n\n| OpportunitÃ©s | Menaces |\n|---|---|\n| ${p.swot.opportunites || 'â€”'} | ${p.swot.menaces || 'â€”'} |\n\n`;
    md += `## âœŠ AGIR\n\n### Message\n`;
    if (p.message.accroche) md += `**${p.message.accroche}**\n\n`;
    if (p.message.action) md += `â†’ **${p.message.action}**\n\n`;
    if (p.smart.length) { md += '### Objectifs\n'; p.smart.forEach((s, i) => md += `${i + 1}. ${s.text}\n`); }
    dl(md, `${slug(p.name)}.md`, 'text/markdown');
    toast('Export MD OK', 'success');
}

async function exportPDF() {
    if (!current) return;
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const p = current;
    doc.setFontSize(18); doc.text(p.name, 20, 20);
    doc.setFontSize(10); doc.setTextColor(100); doc.text(`ExportÃ© le ${new Date().toLocaleDateString('fr-FR')}`, 20, 28);
    let y = 40;
    doc.setFontSize(12); doc.setTextColor(0); doc.text('VISION', 20, y); y += 8;
    doc.setFontSize(10);
    const vis = doc.splitTextToSize(p.domino.vision || 'â€”', 170);
    doc.text(vis, 20, y); y += vis.length * 5 + 10;
    doc.setFontSize(12); doc.text('PROBLÃˆME', 20, y); y += 8;
    doc.setFontSize(10);
    const prob = doc.splitTextToSize(p.arbre.probleme || 'â€”', 170);
    doc.text(prob, 20, y); y += prob.length * 5 + 10;
    if (p.message.accroche || p.message.action) {
        doc.setFontSize(12); doc.text('MESSAGE', 20, y); y += 8;
        doc.setFontSize(10);
        if (p.message.accroche) { doc.text(p.message.accroche, 20, y); y += 6; }
        if (p.message.action) { doc.text('â†’ ' + p.message.action, 20, y); }
    }
    doc.save(`${slug(p.name)}.pdf`);
    toast('Export PDF OK', 'success');
}

function esc(s) { return s ? s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>') : ''; }
function slug(s) { return s.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '') || 'projet'; }
function dl(content, name, type) { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([content], { type })); a.download = name; a.click(); }
function toast(msg, type = 'info') { const t = document.createElement('div'); t.className = 'toast'; t.innerHTML = `<span>${{ success: 'âœ“', error: 'âœ•', warning: 'âš ', info: 'â„¹' }[type] || 'â„¹'}</span> ${msg}`; document.getElementById('toast-container').appendChild(t); setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 300); }, 2500); }
</script>
</body>
</html>
