<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plaidoyer Citoyen â€” Poste de Travail v5</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- CDN fiables et testÃ©s -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docx@8.2.0/build/index.umd.min.js"></script>
    <style>
:root{--bg:#0a0a0b;--bg-panel:#12141a;--bg-card:#1a1d24;--bg-input:#22262f;--border:#2a2f3a;--border-light:#363c4a;--text:#f4f4f5;--text-muted:#71717a;--accent:#f59e0b;--accent-dim:#b45309;--success:#22c55e;--danger:#ef4444;--info:#3b82f6;--voir:#0ea5e9;--juger:#f59e0b;--agir:#22c55e}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',system-ui,sans-serif;background:var(--bg);color:var(--text);line-height:1.5;overflow:hidden}
.app{display:grid;grid-template-columns:260px 1fr 380px;height:100vh}

/* SIDEBAR */
.sidebar{background:var(--bg-panel);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
.sidebar-header{padding:1.25rem;border-bottom:1px solid var(--border)}
.logo{display:flex;align-items:center;gap:0.6rem}
.logo-icon{width:36px;height:36px;background:linear-gradient(135deg,var(--accent),#ea580c);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.1rem}
.logo-text{font-weight:700;font-size:1rem}
.logo-sub{font-size:0.65rem;color:var(--text-muted)}

.projects-section{padding:0.75rem;border-bottom:1px solid var(--border)}
.section-title{font-size:0.65rem;font-weight:600;text-transform:uppercase;letter-spacing:0.05em;color:var(--text-muted);padding:0.5rem}
.project-list{max-height:180px;overflow-y:auto}
.project-item{display:flex;align-items:center;gap:0.5rem;padding:0.5rem 0.6rem;border-radius:6px;cursor:pointer;font-size:0.85rem;transition:background 0.15s}
.project-item:hover{background:var(--bg-card)}
.project-item.active{background:var(--accent-dim);color:white}
.project-item-name{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.project-item-delete{opacity:0;background:none;border:none;color:var(--danger);cursor:pointer;font-size:0.8rem;padding:0.2rem}
.project-item:hover .project-item-delete{opacity:0.7}
.btn-new-project{width:100%;padding:0.5rem;margin-top:0.5rem;background:var(--bg-card);border:1px dashed var(--border-light);border-radius:6px;color:var(--text-muted);font-size:0.8rem;cursor:pointer}
.btn-new-project:hover{background:var(--bg-input);color:var(--text);border-color:var(--accent)}

.nav-section{flex:1;overflow-y:auto;padding:0.5rem}
.nav-group-title{font-size:0.65rem;font-weight:600;text-transform:uppercase;letter-spacing:0.05em;color:var(--text-muted);padding:0.75rem 0.5rem 0.25rem}
.nav-group-title.voir{color:var(--voir)}
.nav-group-title.juger{color:var(--juger)}
.nav-group-title.agir{color:var(--agir)}
.nav-item{display:flex;align-items:center;gap:0.5rem;padding:0.45rem 0.6rem;border-radius:6px;cursor:pointer;font-size:0.8rem;color:var(--text-muted);transition:all 0.15s;border:none;background:none;width:100%;text-align:left}
.nav-item:hover{background:var(--bg-card);color:var(--text)}
.nav-item.active{background:var(--bg-card);color:var(--accent)}

.sidebar-footer{padding:0.75rem 1rem;border-top:1px solid var(--border);font-size:0.7rem;color:var(--text-muted);display:flex;justify-content:space-between}
.save-status{display:flex;align-items:center;gap:0.4rem}
.save-dot{width:6px;height:6px;border-radius:50%;background:var(--success)}
.save-dot.saving{background:var(--accent);animation:pulse 1s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}

/* EDITOR */
.editor{display:flex;flex-direction:column;overflow:hidden;background:var(--bg)}
.editor-header{padding:1rem 1.5rem;border-bottom:1px solid var(--border);background:var(--bg-panel)}
.editor-title{font-size:1.1rem;font-weight:600}
.editor-content{flex:1;overflow-y:auto;padding:1.5rem}

.page{display:none;max-width:900px}
.page.active{display:block;animation:fadeIn 0.2s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.page-intro{color:var(--text-muted);font-size:0.9rem;margin-bottom:1.5rem;padding-bottom:1rem;border-bottom:1px solid var(--border)}

.card{background:var(--bg-card);border:1px solid var(--border);border-radius:10px;margin-bottom:1rem}
.card-header{padding:0.75rem 1rem;border-bottom:1px solid var(--border);font-weight:600;font-size:0.9rem}
.card-body{padding:1rem}

.form-group{margin-bottom:1rem}
.form-group:last-child{margin-bottom:0}
.form-label{display:block;font-size:0.8rem;font-weight:500;margin-bottom:0.4rem;color:var(--text-muted)}
.form-input,.form-textarea,.form-select{width:100%;padding:0.6rem 0.8rem;background:var(--bg-input);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:inherit;font-size:0.9rem}
.form-input:focus,.form-textarea:focus,.form-select:focus{outline:none;border-color:var(--accent)}
.form-textarea{min-height:100px;resize:vertical;line-height:1.6}
.form-hint{font-size:0.7rem;color:var(--text-muted);margin-top:0.3rem}
.form-row{display:grid;grid-template-columns:repeat(2,1fr);gap:1rem}
.form-row-3{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem}

.btn{display:inline-flex;align-items:center;justify-content:center;gap:0.4rem;padding:0.5rem 1rem;font-family:inherit;font-size:0.8rem;font-weight:500;border-radius:6px;border:none;cursor:pointer;transition:all 0.15s}
.btn-primary{background:var(--accent);color:#000}
.btn-primary:hover{background:var(--accent-dim)}
.btn-secondary{background:var(--bg-input);color:var(--text);border:1px solid var(--border)}
.btn-secondary:hover{background:var(--bg-card)}
.btn-sm{padding:0.35rem 0.7rem;font-size:0.75rem}

/* STATS */
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;margin-bottom:1.5rem}
.stat-card{background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:1rem}
.stat-icon{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;margin-bottom:0.75rem}
.stat-value{font-size:1.5rem;font-weight:700}
.stat-label{font-size:0.75rem;color:var(--text-muted)}

.progress-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin-bottom:1.5rem}
.progress-card{background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:1rem}
.progress-title{font-size:0.85rem;font-weight:600;margin-bottom:0.75rem}
.progress-bar{height:8px;background:var(--bg-input);border-radius:4px;overflow:hidden}
.progress-fill{height:100%;border-radius:4px;transition:width 0.3s}
.progress-label{display:flex;justify-content:space-between;font-size:0.7rem;color:var(--text-muted);margin-top:0.4rem}

/* ACTORS */
.actor-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin-top:1rem}
.actor-column{background:var(--bg-input);border-radius:8px;padding:0.75rem;min-height:150px}
.actor-column-title{font-size:0.75rem;font-weight:600;margin-bottom:0.5rem;padding-bottom:0.5rem;border-bottom:1px solid var(--border)}
.actor-column.ally .actor-column-title{color:var(--success)}
.actor-column.neutral .actor-column-title{color:var(--text-muted)}
.actor-column.opponent .actor-column-title{color:var(--danger)}
.actor-chip{display:flex;align-items:center;gap:0.4rem;padding:0.4rem 0.5rem;background:var(--bg-card);border-radius:4px;font-size:0.75rem;margin-bottom:0.4rem}
.actor-chip-power{color:var(--accent);font-size:0.65rem}
.actor-chip-delete{margin-left:auto;background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:0.7rem}
.actor-chip-delete:hover{color:var(--danger)}

.mermaid-container{background:var(--bg-input);border-radius:8px;padding:1rem;margin-top:1rem;overflow-x:auto}
.mermaid{text-align:center}

/* SMART & JOURNAL */
.smart-item,.journal-entry{display:flex;align-items:flex-start;gap:0.6rem;padding:0.6rem;background:var(--bg-input);border-radius:6px;margin-bottom:0.5rem}
.smart-checkbox{margin-top:0.2rem;width:16px;height:16px}
.smart-content,.journal-content{flex:1}
.smart-text,.journal-text{font-size:0.85rem}
.smart-text.done{text-decoration:line-through;opacity:0.6}
.smart-meta,.journal-date{font-size:0.7rem;color:var(--text-muted);margin-top:0.2rem}
.journal-icon{font-size:1.2rem}

/* EXPORT */
.export-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem}
.export-option{display:flex;flex-direction:column;align-items:center;gap:0.5rem;padding:1.25rem;background:var(--bg-input);border:2px solid var(--border);border-radius:10px;cursor:pointer;transition:all 0.15s}
.export-option:hover{border-color:var(--accent);background:var(--bg-card)}
.export-option.disabled{opacity:0.5;cursor:not-allowed}
.export-icon{font-size:2rem}
.export-label{font-weight:600;font-size:0.9rem}
.export-desc{font-size:0.7rem;color:var(--text-muted)}

/* PREVIEW */
.preview{background:var(--bg-panel);border-left:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
.preview-header{padding:1rem 1.25rem;border-bottom:1px solid var(--border);font-size:0.9rem;font-weight:600}
.preview-content{flex:1;overflow-y:auto;padding:1.25rem}
.preview-doc{background:#13151a;border-radius:8px;padding:1.5rem;font-size:0.85rem;line-height:1.7}
.preview-doc h1{font-size:1.3rem;color:var(--accent);margin-bottom:0.25rem;padding-bottom:0.75rem;border-bottom:2px solid var(--border)}
.preview-doc .doc-meta{font-size:0.75rem;color:var(--text-muted);margin-bottom:1.5rem}
.preview-doc h2{font-size:1rem;margin-top:1.5rem;margin-bottom:0.75rem}
.preview-doc h2.voir{color:var(--voir)}
.preview-doc h2.juger{color:var(--juger)}
.preview-doc h2.agir{color:var(--agir)}
.preview-doc h3{font-size:0.9rem;color:var(--text);margin-top:1rem;margin-bottom:0.5rem}
.preview-doc p{margin-bottom:0.75rem;color:var(--text-muted)}
.preview-doc p.filled{color:var(--text)}
.preview-doc .empty{font-style:italic;opacity:0.5}
.preview-doc .actor-badge{display:inline-block;padding:0.15rem 0.5rem;border-radius:100px;font-size:0.7rem;margin:0.15rem}
.preview-doc .actor-badge.ally{background:rgba(34,197,94,0.2);color:var(--success)}
.preview-doc .actor-badge.neutral{background:rgba(113,113,122,0.2);color:var(--text-muted)}
.preview-doc .actor-badge.opponent{background:rgba(239,68,68,0.2);color:var(--danger)}
.preview-doc table{width:100%;border-collapse:collapse;margin:0.75rem 0;font-size:0.8rem}
.preview-doc th,.preview-doc td{padding:0.5rem;border:1px solid var(--border);text-align:left}
.preview-doc th{background:var(--bg-input)}
.preview-actions{padding:1rem 1.25rem;border-top:1px solid var(--border);display:flex;gap:0.5rem;flex-wrap:wrap}
.preview-actions .btn{flex:1;min-width:60px}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.75);display:none;align-items:center;justify-content:center;z-index:1000}
.modal-overlay.show{display:flex}
.modal{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:1.5rem;width:450px;max-width:90vw}
.modal-title{font-size:1.1rem;font-weight:600;margin-bottom:1rem}
.modal-actions{display:flex;gap:0.5rem;justify-content:flex-end;margin-top:1.5rem}

/* TOAST */
.toast-container{position:fixed;bottom:1rem;left:50%;transform:translateX(-50%);z-index:1001;display:flex;flex-direction:column;gap:0.5rem}
.toast{background:var(--bg-card);border:1px solid var(--border);padding:0.75rem 1.25rem;border-radius:8px;font-size:0.85rem;display:flex;align-items:center;gap:0.5rem;box-shadow:0 10px 40px rgba(0,0,0,0.4);animation:toastIn 0.3s ease}
.toast.success{border-left:3px solid var(--success)}
.toast.error{border-left:3px solid var(--danger)}
.toast.warning{border-left:3px solid var(--accent)}
@keyframes toastIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

.empty-state{text-align:center;padding:3rem 1rem;color:var(--text-muted)}
.empty-state-icon{font-size:3rem;margin-bottom:1rem;opacity:0.5}
.empty-state-title{font-size:1.1rem;font-weight:600;color:var(--text);margin-bottom:0.5rem}
.empty-state-text{font-size:0.85rem;margin-bottom:1.5rem}

/* STATUS BAR */
.status-bar{background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:0.75rem 1rem;margin-bottom:1rem;display:flex;gap:1rem;flex-wrap:wrap;font-size:0.75rem}
.status-item{display:flex;align-items:center;gap:0.4rem}
.status-ok{color:var(--success)}
.status-error{color:var(--danger)}

@media(max-width:1100px){.app{grid-template-columns:240px 1fr 320px}.stats-grid{grid-template-columns:repeat(2,1fr)}}
@media(max-width:900px){.app{grid-template-columns:1fr}.sidebar,.preview{display:none}}
    </style>
</head>
<body>
<div class="app">
<!-- SIDEBAR -->
<aside class="sidebar">
    <div class="sidebar-header">
        <div class="logo">
            <div class="logo-icon">âš–ï¸</div>
            <div>
                <div class="logo-text">Plaidoyer Citoyen</div>
                <div class="logo-sub">v5 â€” Poste de Travail</div>
            </div>
        </div>
    </div>
    
    <div class="projects-section">
        <div class="section-title">ğŸ“ Mes projets</div>
        <div class="project-list" id="project-list"></div>
        <button class="btn-new-project" onclick="createProject()">+ Nouveau projet</button>
    </div>
    
    <nav class="nav-section">
        <div class="nav-group-title">ğŸ“Š GÃ©nÃ©ral</div>
        <button class="nav-item active" data-page="dashboard">ğŸ“Š Tableau de bord</button>
        
        <div class="nav-group-title voir">ğŸ‘ï¸ VOIR</div>
        <button class="nav-item" data-page="domino">ğŸ¯ Vision (Domino)</button>
        <button class="nav-item" data-page="profil">ğŸ‘¤ Profil citoyen</button>
        <button class="nav-item" data-page="fleur">ğŸŒ¸ Fleur du pouvoir</button>
        
        <div class="nav-group-title juger">âš–ï¸ JUGER</div>
        <button class="nav-item" data-page="acteurs">ğŸ‘¥ Acteurs</button>
        <button class="nav-item" data-page="arbre">ğŸŒ³ Arbre Ã  problÃ¨mes</button>
        <button class="nav-item" data-page="pourquoi">â“ 5 Pourquoi</button>
        <button class="nav-item" data-page="swot">ğŸ“ SWOT</button>
        <button class="nav-item" data-page="pestel">ğŸŒ PESTEL</button>
        <button class="nav-item" data-page="tdc">ğŸ”„ ThÃ©orie du changement</button>
        
        <div class="nav-group-title agir">âœŠ AGIR</div>
        <button class="nav-item" data-page="pouvoir">âš¡ Avec/Sans/Contre</button>
        <button class="nav-item" data-page="cibles">ğŸ¯ Cibles & AlliÃ©s</button>
        <button class="nav-item" data-page="smart">ğŸ“‹ Objectifs SMART</button>
        <button class="nav-item" data-page="message">ğŸ’¬ Message clÃ©</button>
        <button class="nav-item" data-page="evaluation">ğŸ“ˆ Suivi-Ã©valuation</button>
        <button class="nav-item" data-page="journal">ğŸ““ Journal de bord</button>
        
        <div class="nav-group-title">ğŸ”§ Outils</div>
        <button class="nav-item" data-page="export">ğŸ’¾ Import / Export</button>
    </nav>
    
    <div class="sidebar-footer">
        <div class="save-status">
            <span class="save-dot" id="save-dot"></span>
            <span id="save-text">PrÃªt</span>
        </div>
        <span id="storage-info">IndexedDB</span>
    </div>
</aside>

<!-- EDITOR -->
<main class="editor">
    <header class="editor-header">
        <h1 class="editor-title" id="editor-title">Tableau de bord</h1>
    </header>
    
    <div class="editor-content" id="editor-content">
        <!-- EMPTY STATE -->
        <div class="page active" id="page-empty">
            <div class="status-bar" id="libs-status"></div>
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ“‚</div>
                <div class="empty-state-title">Bienvenue dans Plaidoyer Citoyen</div>
                <div class="empty-state-text">CrÃ©ez un nouveau projet pour commencer</div>
                <button class="btn btn-primary" onclick="createProject()">+ CrÃ©er un projet</button>
            </div>
        </div>
        
        <!-- DASHBOARD -->
        <div class="page" id="page-dashboard">
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-icon" style="background:rgba(14,165,233,0.2);color:var(--voir)">ğŸ“</div><div class="stat-value" id="stat-fields">0</div><div class="stat-label">Champs remplis</div></div>
                <div class="stat-card"><div class="stat-icon" style="background:rgba(34,197,94,0.2);color:var(--success)">ğŸ‘¥</div><div class="stat-value" id="stat-actors">0</div><div class="stat-label">Acteurs</div></div>
                <div class="stat-card"><div class="stat-icon" style="background:rgba(245,158,11,0.2);color:var(--accent)">ğŸ¯</div><div class="stat-value" id="stat-smart">0</div><div class="stat-label">Objectifs SMART</div></div>
                <div class="stat-card"><div class="stat-icon" style="background:rgba(59,130,246,0.2);color:var(--info)">ğŸ““</div><div class="stat-value" id="stat-journal">0</div><div class="stat-label">EntrÃ©es journal</div></div>
            </div>
            <div class="progress-grid">
                <div class="progress-card"><div class="progress-title" style="color:var(--voir)">ğŸ‘ï¸ Phase VOIR</div><div class="progress-bar"><div class="progress-fill" id="progress-voir" style="background:var(--voir);width:0%"></div></div><div class="progress-label"><span>Analyse</span><span id="progress-voir-pct">0%</span></div></div>
                <div class="progress-card"><div class="progress-title" style="color:var(--juger)">âš–ï¸ Phase JUGER</div><div class="progress-bar"><div class="progress-fill" id="progress-juger" style="background:var(--juger);width:0%"></div></div><div class="progress-label"><span>StratÃ©gie</span><span id="progress-juger-pct">0%</span></div></div>
                <div class="progress-card"><div class="progress-title" style="color:var(--agir)">âœŠ Phase AGIR</div><div class="progress-bar"><div class="progress-fill" id="progress-agir" style="background:var(--agir);width:0%"></div></div><div class="progress-label"><span>Action</span><span id="progress-agir-pct">0%</span></div></div>
            </div>
            <div class="card"><div class="card-header">ğŸ“Œ Informations du projet</div><div class="card-body">
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Nom du projet</label><input type="text" class="form-input" id="project-name-input" data-field="meta.name" placeholder="Ex: Campagne Stop Arizona"></div>
                    <div class="form-group"><label class="form-label">Organisation</label><input type="text" class="form-input" data-field="meta.organization" placeholder="Ex: Collectif citoyen"></div>
                </div>
                <div class="form-group"><label class="form-label">Description</label><textarea class="form-textarea" data-field="meta.description" rows="2" placeholder="RÃ©sumez votre projet..."></textarea></div>
            </div></div>
        </div>
        
        <!-- DOMINO -->
        <div class="page" id="page-domino">
            <p class="page-intro">Clarifiez votre vision du changement.</p>
            <div class="card"><div class="card-header">ğŸ¯ Vision du changement</div><div class="card-body"><textarea class="form-textarea" data-field="domino.vision" rows="4" placeholder="DÃ©crivez le changement que vous souhaitez voir advenir..."></textarea></div></div>
            <div class="form-row">
                <div class="card"><div class="card-header">ğŸš§ Obstacles</div><div class="card-body"><textarea class="form-textarea" data-field="domino.obstacles" rows="5" placeholder="Obstacles politiques, administratifs..."></textarea></div></div>
                <div class="card"><div class="card-header">ğŸ’ª Ressources</div><div class="card-body"><textarea class="form-textarea" data-field="domino.ressources" rows="5" placeholder="RÃ©seaux, expertise, lÃ©gitimitÃ©..."></textarea></div></div>
            </div>
        </div>
        
        <!-- PROFIL -->
        <div class="page" id="page-profil">
            <p class="page-intro">DÃ©finissez votre profil citoyen.</p>
            <div class="form-row">
                <div class="card"><div class="card-header">â¤ï¸ Motivations</div><div class="card-body"><textarea class="form-textarea" data-field="profil.motivations" rows="4" placeholder="Pourquoi vous engagez-vous ?"></textarea></div></div>
                <div class="card"><div class="card-header">ğŸ› ï¸ CompÃ©tences</div><div class="card-body"><textarea class="form-textarea" data-field="profil.competences" rows="4" placeholder="Vos compÃ©tences utiles..."></textarea></div></div>
            </div>
            <div class="form-row">
                <div class="card"><div class="card-header">â° Temps disponible</div><div class="card-body"><textarea class="form-textarea" data-field="profil.temps" rows="4" placeholder="DisponibilitÃ©s..."></textarea></div></div>
                <div class="card"><div class="card-header">âš ï¸ Limites</div><div class="card-body"><textarea class="form-textarea" data-field="profil.limites" rows="4" placeholder="Contraintes, lignes rouges..."></textarea></div></div>
            </div>
        </div>
        
        <!-- FLEUR -->
        <div class="page" id="page-fleur">
            <p class="page-intro">Analysez les rapports de pouvoir et de privilÃ¨ge.</p>
            <div class="card"><div class="card-header">ğŸ‘¥ Personnes concernÃ©es</div><div class="card-body"><textarea class="form-textarea" data-field="fleur.identites" rows="3" placeholder="Profils des personnes touchÃ©es..."></textarea></div></div>
            <div class="form-row">
                <div class="card"><div class="card-header" style="color:var(--success)">âœ… PrivilÃ¨ges</div><div class="card-body"><textarea class="form-textarea" data-field="fleur.privileges" rows="4" placeholder="AccÃ¨s, capital social..."></textarea></div></div>
                <div class="card"><div class="card-header" style="color:var(--danger)">ğŸ¯ Oppressions</div><div class="card-body"><textarea class="form-textarea" data-field="fleur.oppressions" rows="4" placeholder="Discriminations, violences..."></textarea></div></div>
            </div>
        </div>
        
        <!-- ACTEURS -->
        <div class="page" id="page-acteurs">
            <p class="page-intro">Cartographiez les acteurs clÃ©s.</p>
            <div class="card"><div class="card-header">â• Ajouter un acteur</div><div class="card-body">
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Nom</label><input type="text" class="form-input" id="actor-name" placeholder="Nom"></div>
                    <div class="form-group"><label class="form-label">RÃ´le</label><input type="text" class="form-input" id="actor-role" placeholder="Fonction..."></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Position</label><select class="form-select" id="actor-position"><option value="ally">ğŸŸ¢ AlliÃ©</option><option value="neutral">ğŸŸ¡ Neutre</option><option value="opponent">ğŸ”´ Opposant</option></select></div>
                    <div class="form-group"><label class="form-label">Pouvoir</label><select class="form-select" id="actor-power"><option value="1">1â˜…</option><option value="2">2â˜…â˜…</option><option value="3" selected>3â˜…â˜…â˜…</option><option value="4">4â˜…â˜…â˜…â˜…</option><option value="5">5â˜…â˜…â˜…â˜…â˜…</option></select></div>
                </div>
                <button class="btn btn-primary" onclick="addActor()">Ajouter</button>
            </div></div>
            <div class="actor-grid">
                <div class="actor-column ally"><div class="actor-column-title">ğŸŸ¢ AlliÃ©s</div><div id="actors-ally"></div></div>
                <div class="actor-column neutral"><div class="actor-column-title">ğŸŸ¡ Neutres</div><div id="actors-neutral"></div></div>
                <div class="actor-column opponent"><div class="actor-column-title">ğŸ”´ Opposants</div><div id="actors-opponent"></div></div>
            </div>
            <div class="card" style="margin-top:1rem"><div class="card-header">ğŸ“Š Visualisation</div><div class="card-body">
                <div class="mermaid-container"><pre class="mermaid" id="actors-mermaid"></pre></div>
                <button class="btn btn-secondary btn-sm" style="margin-top:0.75rem" onclick="renderActorsMermaid()">ğŸ”„ RafraÃ®chir</button>
            </div></div>
        </div>
        
        <!-- ARBRE -->
        <div class="page" id="page-arbre">
            <p class="page-intro">Identifiez le problÃ¨me central, ses causes et effets.</p>
            <div class="card"><div class="card-header">ğŸ¯ ProblÃ¨me central</div><div class="card-body"><textarea class="form-textarea" data-field="arbre.probleme" rows="2" placeholder="Quel est le problÃ¨me ?"></textarea></div></div>
            <div class="form-row">
                <div class="card"><div class="card-header">ğŸŒ± Causes</div><div class="card-body"><textarea class="form-textarea" data-field="arbre.causes" rows="5" placeholder="Une cause par ligne..."></textarea><p class="form-hint">Une cause par ligne</p></div></div>
                <div class="card"><div class="card-header">ğŸƒ Effets</div><div class="card-body"><textarea class="form-textarea" data-field="arbre.effets" rows="5" placeholder="Un effet par ligne..."></textarea><p class="form-hint">Un effet par ligne</p></div></div>
            </div>
            <div class="card"><div class="card-header">ğŸŒ³ Visualisation</div><div class="card-body">
                <div class="mermaid-container"><pre class="mermaid" id="tree-mermaid"></pre></div>
                <button class="btn btn-secondary btn-sm" style="margin-top:0.75rem" onclick="renderTreeMermaid()">ğŸ”„ RafraÃ®chir</button>
            </div></div>
        </div>
        
        <!-- 5 POURQUOI -->
        <div class="page" id="page-pourquoi">
            <p class="page-intro">Remontez Ã  la cause racine avec la mÃ©thode des 5 Pourquoi.</p>
            <div class="card"><div class="card-header">â“ ProblÃ¨me de dÃ©part</div><div class="card-body"><textarea class="form-textarea" data-field="pourquoi.probleme" rows="2" placeholder="SymptÃ´me observÃ©..."></textarea></div></div>
            <div class="card"><div class="card-body">
                <div class="form-group"><label class="form-label">1ï¸âƒ£ Pourquoi ?</label><textarea class="form-textarea" data-field="pourquoi.why1" rows="2"></textarea></div>
                <div class="form-group"><label class="form-label">2ï¸âƒ£ Pourquoi ?</label><textarea class="form-textarea" data-field="pourquoi.why2" rows="2"></textarea></div>
                <div class="form-group"><label class="form-label">3ï¸âƒ£ Pourquoi ?</label><textarea class="form-textarea" data-field="pourquoi.why3" rows="2"></textarea></div>
                <div class="form-group"><label class="form-label">4ï¸âƒ£ Pourquoi ?</label><textarea class="form-textarea" data-field="pourquoi.why4" rows="2"></textarea></div>
                <div class="form-group"><label class="form-label">5ï¸âƒ£ Pourquoi ? â†’ <strong style="color:var(--accent)">Cause racine</strong></label><textarea class="form-textarea" data-field="pourquoi.why5" rows="2" style="border-color:var(--accent)"></textarea></div>
            </div></div>
        </div>
        
        <!-- SWOT -->
        <div class="page" id="page-swot">
            <p class="page-intro">Analysez Forces, Faiblesses, OpportunitÃ©s, Menaces.</p>
            <div class="form-row">
                <div class="card"><div class="card-header" style="color:var(--success)">ğŸ’ª Forces</div><div class="card-body"><textarea class="form-textarea" data-field="swot.forces" rows="4" placeholder="Atouts internes..."></textarea></div></div>
                <div class="card"><div class="card-header" style="color:var(--danger)">ğŸ˜° Faiblesses</div><div class="card-body"><textarea class="form-textarea" data-field="swot.faiblesses" rows="4" placeholder="Limites internes..."></textarea></div></div>
            </div>
            <div class="form-row">
                <div class="card"><div class="card-header" style="color:var(--info)">ğŸŒŸ OpportunitÃ©s</div><div class="card-body"><textarea class="form-textarea" data-field="swot.opportunites" rows="4" placeholder="Facteurs favorables..."></textarea></div></div>
                <div class="card"><div class="card-header" style="color:var(--accent)">âš ï¸ Menaces</div><div class="card-body"><textarea class="form-textarea" data-field="swot.menaces" rows="4" placeholder="Facteurs dÃ©favorables..."></textarea></div></div>
            </div>
        </div>
        
        <!-- PESTEL -->
        <div class="page" id="page-pestel">
            <p class="page-intro">Analysez le macro-environnement PESTEL.</p>
            <div class="form-row">
                <div class="card"><div class="card-header">ğŸ›ï¸ Politique</div><div class="card-body"><textarea class="form-textarea" data-field="pestel.politique" rows="3" placeholder="Gouvernance..."></textarea></div></div>
                <div class="card"><div class="card-header">ğŸ’¶ Ã‰conomique</div><div class="card-body"><textarea class="form-textarea" data-field="pestel.economique" rows="3" placeholder="Conjoncture..."></textarea></div></div>
            </div>
            <div class="form-row">
                <div class="card"><div class="card-header">ğŸ‘¥ Social</div><div class="card-body"><textarea class="form-textarea" data-field="pestel.social" rows="3" placeholder="Tendances..."></textarea></div></div>
                <div class="card"><div class="card-header">ğŸ’» Technologique</div><div class="card-body"><textarea class="form-textarea" data-field="pestel.technologique" rows="3" placeholder="Innovations..."></textarea></div></div>
            </div>
            <div class="form-row">
                <div class="card"><div class="card-header">ğŸŒ± Environnemental</div><div class="card-body"><textarea class="form-textarea" data-field="pestel.environnemental" rows="3" placeholder="Ã‰cologie..."></textarea></div></div>
                <div class="card"><div class="card-header">âš–ï¸ LÃ©gal</div><div class="card-body"><textarea class="form-textarea" data-field="pestel.legal" rows="3" placeholder="Juridique..."></textarea></div></div>
            </div>
        </div>
        
        <!-- TDC -->
        <div class="page" id="page-tdc">
            <p class="page-intro">ThÃ©orie du Changement : comment le changement se produit.</p>
            <div class="card"><div class="card-header">ğŸ¯ Impact final</div><div class="card-body"><textarea class="form-textarea" data-field="tdc.impact" rows="2" placeholder="Changement ultime visÃ©..."></textarea></div></div>
            <div class="form-row">
                <div class="card"><div class="card-header">ğŸ”¹ Individuel interne</div><div class="card-body"><textarea class="form-textarea" data-field="tdc.individuel_interne" rows="3" placeholder="Connaissances, attitudes..."></textarea></div></div>
                <div class="card"><div class="card-header">ğŸ”¹ Individuel externe</div><div class="card-body"><textarea class="form-textarea" data-field="tdc.individuel_externe" rows="3" placeholder="Comportements..."></textarea></div></div>
            </div>
            <div class="form-row">
                <div class="card"><div class="card-header">ğŸ”¸ Collectif interne</div><div class="card-body"><textarea class="form-textarea" data-field="tdc.collectif_interne" rows="3" placeholder="Culture, normes..."></textarea></div></div>
                <div class="card"><div class="card-header">ğŸ”¸ Collectif externe</div><div class="card-body"><textarea class="form-textarea" data-field="tdc.collectif_externe" rows="3" placeholder="Politiques, lois..."></textarea></div></div>
            </div>
        </div>
        
        <!-- POUVOIR -->
        <div class="page" id="page-pouvoir">
            <p class="page-intro">Positionnement stratÃ©gique par rapport au pouvoir.</p>
            <div class="form-row-3">
                <div class="card"><div class="card-header" style="color:var(--success);border-bottom:3px solid var(--success)">ğŸ¤ AVEC</div><div class="card-body"><textarea class="form-textarea" data-field="pouvoir.avec" rows="6" placeholder="Collaboration, dialogue..."></textarea></div></div>
                <div class="card"><div class="card-header" style="color:var(--accent);border-bottom:3px solid var(--accent)">ğŸ”„ SANS</div><div class="card-body"><textarea class="form-textarea" data-field="pouvoir.sans" rows="6" placeholder="Actions autonomes..."></textarea></div></div>
                <div class="card"><div class="card-header" style="color:var(--danger);border-bottom:3px solid var(--danger)">âœŠ CONTRE</div><div class="card-body"><textarea class="form-textarea" data-field="pouvoir.contre" rows="6" placeholder="Opposition, mobilisation..."></textarea></div></div>
            </div>
        </div>
        
        <!-- CIBLES -->
        <div class="page" id="page-cibles">
            <p class="page-intro">Identifiez vos cibles et alliÃ©s stratÃ©giques.</p>
            <div class="form-row">
                <div class="card"><div class="card-header">ğŸ¯ Cible principale</div><div class="card-body"><textarea class="form-textarea" data-field="cibles.principale" rows="3" placeholder="Qui dÃ©cide ?"></textarea></div></div>
                <div class="card"><div class="card-header">ğŸ¯ Cibles secondaires</div><div class="card-body"><textarea class="form-textarea" data-field="cibles.secondaires" rows="3" placeholder="Qui influence ?"></textarea></div></div>
            </div>
            <div class="form-row">
                <div class="card"><div class="card-header" style="color:var(--success)">ğŸ¤ AlliÃ©s</div><div class="card-body"><textarea class="form-textarea" data-field="cibles.allies" rows="3" placeholder="Organisations alliÃ©es..."></textarea></div></div>
                <div class="card"><div class="card-header" style="color:var(--danger)">âš”ï¸ Opposants</div><div class="card-body"><textarea class="form-textarea" data-field="cibles.opposants" rows="3" placeholder="Qui s'oppose ?"></textarea></div></div>
            </div>
        </div>
        
        <!-- SMART -->
        <div class="page" id="page-smart">
            <p class="page-intro">Objectifs SMART : SpÃ©cifiques, Mesurables, Atteignables, RÃ©alistes, Temporels.</p>
            <div class="card"><div class="card-header">â• Ajouter un objectif</div><div class="card-body">
                <div class="form-group"><textarea class="form-textarea" id="smart-text" rows="2" placeholder="Ex: Obtenir 50 000 signatures d'ici le 1er mars"></textarea></div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Indicateur</label><input type="text" class="form-input" id="smart-indicator" placeholder="Ex: Nombre de signatures"></div>
                    <div class="form-group"><label class="form-label">Ã‰chÃ©ance</label><input type="date" class="form-input" id="smart-deadline"></div>
                </div>
                <button class="btn btn-primary" onclick="addSmart()">Ajouter</button>
            </div></div>
            <div class="card"><div class="card-header">ğŸ“‹ Objectifs</div><div class="card-body" id="smart-list"><p style="color:var(--text-muted);text-align:center">Aucun objectif</p></div></div>
        </div>
        
        <!-- MESSAGE -->
        <div class="page" id="page-message">
            <p class="page-intro">Construisez votre message de plaidoyer.</p>
            <div class="card"><div class="card-header">ğŸ’¬ Message</div><div class="card-body">
                <div class="form-group"><label class="form-label">ğŸ£ Accroche</label><textarea class="form-textarea" data-field="message.accroche" rows="2" placeholder="Phrase percutante..."></textarea></div>
                <div class="form-group"><label class="form-label">â— ProblÃ¨me</label><textarea class="form-textarea" data-field="message.probleme" rows="2" placeholder="Le problÃ¨me..."></textarea></div>
                <div class="form-group"><label class="form-label">âš¡ Importance</label><textarea class="form-textarea" data-field="message.importance" rows="2" placeholder="Pourquoi agir ?"></textarea></div>
                <div class="form-group"><label class="form-label">ğŸ‘‰ Appel Ã  l'action</label><textarea class="form-textarea" data-field="message.action" rows="2" placeholder="Que demandez-vous ?"></textarea></div>
            </div></div>
            <div class="card"><div class="card-header">ğŸ“ AperÃ§u</div><div class="card-body" id="message-preview" style="background:var(--bg-input);border-radius:6px;padding:1rem;font-style:italic;color:var(--text-muted)">Remplissez les champs...</div></div>
        </div>
        
        <!-- EVALUATION -->
        <div class="page" id="page-evaluation">
            <p class="page-intro">Suivi et Ã©valuation de l'impact.</p>
            <div class="form-row">
                <div class="card"><div class="card-header">ğŸ“Š Indicateurs</div><div class="card-body"><textarea class="form-textarea" data-field="evaluation.indicateurs" rows="5" placeholder="Indicateurs quantitatifs et qualitatifs..."></textarea></div></div>
                <div class="card"><div class="card-header">ğŸ” MÃ©thodes</div><div class="card-body"><textarea class="form-textarea" data-field="evaluation.methodes" rows="5" placeholder="Sondages, entretiens..."></textarea></div></div>
            </div>
            <div class="form-row">
                <div class="card"><div class="card-header">ğŸ“… Calendrier</div><div class="card-body"><textarea class="form-textarea" data-field="evaluation.calendrier" rows="5" placeholder="FrÃ©quence, jalons..."></textarea></div></div>
                <div class="card"><div class="card-header">ğŸ“š LeÃ§ons apprises</div><div class="card-body"><textarea class="form-textarea" data-field="evaluation.lecons" rows="5" placeholder="Apprentissages..."></textarea></div></div>
            </div>
        </div>
        
        <!-- JOURNAL -->
        <div class="page" id="page-journal">
            <p class="page-intro">Journal de bord de vos actions.</p>
            <div class="card"><div class="card-header">â• Nouvelle entrÃ©e</div><div class="card-body">
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Date</label><input type="date" class="form-input" id="journal-date"></div>
                    <div class="form-group"><label class="form-label">Type</label><select class="form-select" id="journal-type"><option value="action">ğŸ¯ Action</option><option value="rencontre">ğŸ¤ Rencontre</option><option value="victoire">ğŸ† Victoire</option><option value="difficulte">âš ï¸ DifficultÃ©</option><option value="note">ğŸ“ Note</option></select></div>
                </div>
                <div class="form-group"><textarea class="form-textarea" id="journal-content" rows="2" placeholder="DÃ©crivez..."></textarea></div>
                <button class="btn btn-primary" onclick="addJournal()">Ajouter</button>
            </div></div>
            <div class="card"><div class="card-header">ğŸ““ Historique</div><div class="card-body" id="journal-list"><p style="color:var(--text-muted);text-align:center">Aucune entrÃ©e</p></div></div>
        </div>
        
        <!-- EXPORT -->
        <div class="page" id="page-export">
            <div class="card"><div class="card-header">ğŸ“¤ Exporter</div><div class="card-body">
                <p style="margin-bottom:1rem;color:var(--text-muted)">Exportez votre projet :</p>
                <div class="export-grid">
                    <div class="export-option" onclick="exportJSON()"><span class="export-icon">ğŸ“„</span><span class="export-label">JSON</span><span class="export-desc">Sauvegarde complÃ¨te</span></div>
                    <div class="export-option" onclick="exportMD()"><span class="export-icon">ğŸ“</span><span class="export-label">Markdown</span><span class="export-desc">Document texte</span></div>
                    <div class="export-option" onclick="exportHTML()"><span class="export-icon">ğŸŒ</span><span class="export-label">HTML</span><span class="export-desc">Page web</span></div>
                    <div class="export-option" onclick="exportPDF()"><span class="export-icon">ğŸ“•</span><span class="export-label">PDF</span><span class="export-desc">Document</span></div>
                    <div class="export-option" id="docx-export" onclick="exportDOCX()"><span class="export-icon">ğŸ“˜</span><span class="export-label">Word</span><span class="export-desc">Document Ã©ditable</span></div>
                    <div class="export-option" id="xlsx-export" onclick="exportXLSX()"><span class="export-icon">ğŸ“Š</span><span class="export-label">Excel</span><span class="export-desc">Tableur</span></div>
                </div>
            </div></div>
            <div class="card"><div class="card-header">ğŸ“¥ Importer</div><div class="card-body">
                <p style="margin-bottom:0.75rem;color:var(--text-muted)">Chargez un projet JSON :</p>
                <input type="file" id="import-file" accept=".json" class="form-input" onchange="importJSON(event)">
            </div></div>
        </div>
    </div>
</main>

<!-- PREVIEW -->
<aside class="preview">
    <header class="preview-header">ğŸ‘ï¸ AperÃ§u en direct</header>
    <div class="preview-content"><div class="preview-doc" id="preview-doc"></div></div>
    <div class="preview-actions">
        <button class="btn btn-secondary btn-sm" onclick="exportJSON()">JSON</button>
        <button class="btn btn-secondary btn-sm" onclick="exportMD()">MD</button>
        <button class="btn btn-primary btn-sm" onclick="exportPDF()">PDF</button>
    </div>
</aside>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modal">
    <div class="modal">
        <h2 class="modal-title">Nouveau projet</h2>
        <div class="form-group"><label class="form-label">Nom du projet</label><input type="text" class="form-input" id="new-project-name" placeholder="Ex: Campagne Stop Arizona"></div>
        <div class="form-group"><label class="form-label">Description</label><textarea class="form-textarea" id="new-project-desc" rows="2" placeholder="Description..."></textarea></div>
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeModal()">Annuler</button>
            <button class="btn btn-primary" onclick="confirmCreate()">CrÃ©er</button>
        </div>
    </div>
</div>

<div class="toast-container" id="toast-container"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VÃ‰RIFICATION DES LIBS AU CHARGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LIBS = {
    mermaid: () => typeof mermaid !== 'undefined',
    jspdf: () => typeof window.jspdf !== 'undefined',
    xlsx: () => typeof XLSX !== 'undefined',
    docx: () => typeof window.docx !== 'undefined'
};

function checkLibs() {
    const status = document.getElementById('libs-status');
    if (!status) return;
    let html = '';
    for (const [name, check] of Object.entries(LIBS)) {
        const ok = check();
        html += `<span class="status-item ${ok ? 'status-ok' : 'status-error'}">${ok ? 'âœ“' : 'âœ—'} ${name}</span>`;
    }
    status.innerHTML = html;
    console.log('Libs status:', Object.fromEntries(Object.entries(LIBS).map(([k, v]) => [k, v()])));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INDEXEDDB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DB_NAME = 'PlaidoyerCitoyenDB', DB_VERSION = 1;
let db, currentId = null, current = null, saveTimer = null;

async function initDB() {
    return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        req.onerror = () => { console.error('IndexedDB error:', req.error); reject(req.error); };
        req.onsuccess = () => { db = req.result; console.log('IndexedDB ready'); resolve(db); };
        req.onupgradeneeded = (e) => {
            const database = e.target.result;
            if (!database.objectStoreNames.contains('projects')) {
                database.createObjectStore('projects', { keyPath: 'id' });
            }
        };
    });
}

const dbSave = (p) => new Promise((res, rej) => { const req = db.transaction('projects', 'readwrite').objectStore('projects').put(p); req.onsuccess = () => res(); req.onerror = () => rej(req.error); });
const dbGet = (id) => new Promise((res, rej) => { const req = db.transaction('projects').objectStore('projects').get(id); req.onsuccess = () => res(req.result); req.onerror = () => rej(req.error); });
const dbAll = () => new Promise((res, rej) => { const req = db.transaction('projects').objectStore('projects').getAll(); req.onsuccess = () => res(req.result || []); req.onerror = () => rej(req.error); });
const dbDel = (id) => new Promise((res, rej) => { const req = db.transaction('projects', 'readwrite').objectStore('projects').delete(id); req.onsuccess = () => res(); req.onerror = () => rej(req.error); });

function newProject(name, desc = '') {
    const now = new Date().toISOString();
    return {
        id: Date.now().toString(),
        meta: { name, description: desc, organization: '' },
        modified: now,
        domino: { vision: '', obstacles: '', ressources: '' },
        profil: { motivations: '', competences: '', temps: '', limites: '' },
        fleur: { identites: '', privileges: '', oppressions: '' },
        acteurs: [],
        arbre: { probleme: '', causes: '', effets: '' },
        pourquoi: { probleme: '', why1: '', why2: '', why3: '', why4: '', why5: '' },
        swot: { forces: '', faiblesses: '', opportunites: '', menaces: '' },
        pestel: { politique: '', economique: '', social: '', technologique: '', environnemental: '', legal: '' },
        tdc: { impact: '', individuel_interne: '', individuel_externe: '', collectif_interne: '', collectif_externe: '' },
        pouvoir: { avec: '', sans: '', contre: '' },
        cibles: { principale: '', secondaires: '', allies: '', opposants: '' },
        smart: [],
        message: { accroche: '', probleme: '', importance: '', action: '' },
        evaluation: { indicateurs: '', methodes: '', calendrier: '', lecons: '' },
        journal: []
    };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded', async () => {
    try {
        await initDB();
        if (LIBS.mermaid()) {
            mermaid.initialize({ startOnLoad: false, theme: 'dark', securityLevel: 'loose' });
        }
        await renderList();
        initNav();
        initAutoSave();
        document.getElementById('journal-date').value = new Date().toISOString().split('T')[0];
        checkLibs();
        toast('Application prÃªte', 'success');
    } catch (err) {
        console.error('Init error:', err);
        toast('Erreur initialisation: ' + err.message, 'error');
    }
});

function initNav() {
    document.querySelectorAll('.nav-item').forEach(el => {
        el.addEventListener('click', () => {
            if (!currentId && el.dataset.page !== 'empty') {
                toast('SÃ©lectionnez un projet', 'warning');
                return;
            }
            showPage(el.dataset.page);
        });
    });
}

function initAutoSave() {
    document.querySelectorAll('[data-field]').forEach(el => {
        el.addEventListener('input', () => {
            if (!current) return;
            const [a, b] = el.dataset.field.split('.');
            if (!current[a]) current[a] = {};
            current[a][b] = el.value;
            if (a === 'meta' && b === 'name') renderList();
            scheduleSave();
            updatePreview();
            updateStats();
            if (el.dataset.field.startsWith('message.')) updateMessagePreview();
        });
    });
}

function scheduleSave() {
    document.getElementById('save-dot').classList.add('saving');
    document.getElementById('save-text').textContent = 'Sauvegarde...';
    clearTimeout(saveTimer);
    saveTimer = setTimeout(async () => {
        if (current) {
            current.modified = new Date().toISOString();
            await dbSave(current);
            document.getElementById('save-dot').classList.remove('saving');
            document.getElementById('save-text').textContent = 'SauvegardÃ©';
        }
    }, 400);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROJECTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderList() {
    const list = await dbAll();
    const el = document.getElementById('project-list');
    if (!list.length) {
        el.innerHTML = '<p style="color:var(--text-muted);font-size:0.8rem;padding:0.5rem;text-align:center">Aucun projet</p>';
        return;
    }
    el.innerHTML = list.map(p => `
        <div class="project-item ${p.id === currentId ? 'active' : ''}" onclick="selectProject('${p.id}')">
            <span>ğŸ“</span>
            <span class="project-item-name">${esc(p.meta?.name || 'Sans nom')}</span>
            <button class="project-item-delete" onclick="event.stopPropagation();delProject('${p.id}')">âœ•</button>
        </div>
    `).join('');
}

function createProject() {
    document.getElementById('modal').classList.add('show');
    document.getElementById('new-project-name').focus();
}

function closeModal() {
    document.getElementById('modal').classList.remove('show');
    document.getElementById('new-project-name').value = '';
    document.getElementById('new-project-desc').value = '';
}

async function confirmCreate() {
    const name = document.getElementById('new-project-name').value.trim();
    const desc = document.getElementById('new-project-desc').value.trim();
    if (!name) { toast('Entrez un nom', 'error'); return; }
    const p = newProject(name, desc);
    await dbSave(p);
    closeModal();
    await renderList();
    await selectProject(p.id);
    toast('Projet crÃ©Ã©', 'success');
}

async function selectProject(id) {
    currentId = id;
    current = await dbGet(id);
    await renderList();
    populate();
    renderActors();
    renderSmart();
    renderJournal();
    updatePreview();
    updateStats();
    showPage('dashboard');
}

async function delProject(id) {
    if (!confirm('Supprimer ce projet ?')) return;
    await dbDel(id);
    if (currentId === id) { currentId = null; current = null; showPage('empty'); document.getElementById('preview-doc').innerHTML = ''; }
    await renderList();
    toast('Projet supprimÃ©', 'success');
}

function populate() {
    document.querySelectorAll('[data-field]').forEach(el => {
        const [a, b] = el.dataset.field.split('.');
        el.value = current?.[a]?.[b] || '';
    });
    updateMessagePreview();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PAGE_TITLES = { empty: 'Bienvenue', dashboard: 'Tableau de bord', domino: 'Vision (Domino)', profil: 'Profil citoyen', fleur: 'Fleur du pouvoir', acteurs: 'Acteurs', arbre: 'Arbre Ã  problÃ¨mes', pourquoi: '5 Pourquoi', swot: 'SWOT', pestel: 'PESTEL', tdc: 'ThÃ©orie du changement', pouvoir: 'Avec/Sans/Contre', cibles: 'Cibles & AlliÃ©s', smart: 'Objectifs SMART', message: 'Message clÃ©', evaluation: 'Suivi-Ã©valuation', journal: 'Journal de bord', export: 'Import / Export' };

function showPage(id) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(`page-${id}`)?.classList.add('active');
    document.querySelectorAll('.nav-item').forEach(el => el.classList.toggle('active', el.dataset.page === id));
    document.getElementById('editor-title').textContent = PAGE_TITLES[id] || id;
    if (id === 'acteurs') renderActorsMermaid();
    if (id === 'arbre') renderTreeMermaid();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateStats() {
    if (!current) return;
    let filled = 0;
    const count = (obj) => { Object.values(obj || {}).forEach(v => { if (typeof v === 'string' && v.trim()) filled++; }); };
    ['domino', 'profil', 'fleur', 'arbre', 'pourquoi', 'swot', 'pestel', 'tdc', 'pouvoir', 'cibles', 'message', 'evaluation'].forEach(k => count(current[k]));
    
    document.getElementById('stat-fields').textContent = filled;
    document.getElementById('stat-actors').textContent = current.acteurs?.length || 0;
    document.getElementById('stat-smart').textContent = current.smart?.length || 0;
    document.getElementById('stat-journal').textContent = current.journal?.length || 0;
    
    const calcPct = (fields) => {
        let f = 0;
        fields.forEach(path => {
            if (path === 'acteurs') { if (current.acteurs?.length) f++; }
            else if (path === 'smart') { if (current.smart?.length) f++; }
            else { const [a, b] = path.split('.'); if (current[a]?.[b]?.trim()) f++; }
        });
        return Math.round((f / fields.length) * 100);
    };
    
    const vp = calcPct(['domino.vision', 'profil.motivations', 'fleur.identites']);
    const jp = calcPct(['arbre.probleme', 'swot.forces', 'pestel.politique', 'tdc.impact', 'acteurs']);
    const ap = calcPct(['pouvoir.avec', 'cibles.principale', 'message.accroche', 'smart']);
    
    document.getElementById('progress-voir').style.width = vp + '%';
    document.getElementById('progress-voir-pct').textContent = vp + '%';
    document.getElementById('progress-juger').style.width = jp + '%';
    document.getElementById('progress-juger-pct').textContent = jp + '%';
    document.getElementById('progress-agir').style.width = ap + '%';
    document.getElementById('progress-agir-pct').textContent = ap + '%';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACTORS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addActor() {
    if (!current) return;
    const name = document.getElementById('actor-name').value.trim();
    const role = document.getElementById('actor-role').value.trim();
    const position = document.getElementById('actor-position').value;
    const power = +document.getElementById('actor-power').value;
    if (!name) { toast('Entrez un nom', 'error'); return; }
    current.acteurs.push({ id: Date.now(), name, role, position, power });
    renderActors(); scheduleSave(); updatePreview(); updateStats();
    document.getElementById('actor-name').value = '';
    document.getElementById('actor-role').value = '';
    toast('Acteur ajoutÃ©', 'success');
}

function removeActor(id) {
    if (!current) return;
    current.acteurs = current.acteurs.filter(a => a.id !== id);
    renderActors(); scheduleSave(); updatePreview(); updateStats();
}

function renderActors() {
    if (!current) return;
    ['ally', 'neutral', 'opponent'].forEach(pos => {
        const c = document.getElementById(`actors-${pos}`);
        const actors = current.acteurs.filter(a => a.position === pos);
        c.innerHTML = actors.length ? actors.map(a => `
            <div class="actor-chip">
                <span>${esc(a.name)}</span>
                <span class="actor-chip-power">${'â˜…'.repeat(a.power)}</span>
                <button class="actor-chip-delete" onclick="removeActor(${a.id})">âœ•</button>
            </div>
        `).join('') : '<p style="color:var(--text-muted);font-size:0.75rem;text-align:center">â€”</p>';
    });
}

async function renderActorsMermaid() {
    if (!current || !LIBS.mermaid()) return;
    const allies = current.acteurs.filter(a => a.position === 'ally');
    const neutrals = current.acteurs.filter(a => a.position === 'neutral');
    const opponents = current.acteurs.filter(a => a.position === 'opponent');
    let code = 'graph LR\n';
    if (allies.length) { code += '    subgraph AlliÃ©s\n'; allies.forEach((a, i) => code += `    A${i}["${a.name.replace(/"/g, "'")}"]\n`); code += '    end\n'; }
    if (neutrals.length) { code += '    subgraph Neutres\n'; neutrals.forEach((a, i) => code += `    N${i}["${a.name.replace(/"/g, "'")}"]\n`); code += '    end\n'; }
    if (opponents.length) { code += '    subgraph Opposants\n'; opponents.forEach((a, i) => code += `    O${i}["${a.name.replace(/"/g, "'")}"]\n`); code += '    end\n'; }
    if (!allies.length && !neutrals.length && !opponents.length) code += '    X[Ajoutez des acteurs]\n';
    const el = document.getElementById('actors-mermaid');
    el.textContent = code;
    el.removeAttribute('data-processed');
    try { await mermaid.run({ nodes: [el] }); } catch (e) { console.error('Mermaid error:', e); }
}

async function renderTreeMermaid() {
    if (!current || !LIBS.mermaid()) return;
    const prob = (current.arbre?.probleme || 'ProblÃ¨me').substring(0, 30).replace(/"/g, "'");
    const causes = (current.arbre?.causes || '').split('\n').filter(c => c.trim());
    const effects = (current.arbre?.effets || '').split('\n').filter(e => e.trim());
    let code = 'graph TB\n';
    causes.forEach((c, i) => code += `    C${i}["${c.trim().substring(0, 25).replace(/"/g, "'")}"] --> P\n`);
    code += `    P["ğŸ¯ ${prob}"]\n`;
    effects.forEach((e, i) => code += `    P --> E${i}["${e.trim().substring(0, 25).replace(/"/g, "'")}"\n`);
    if (!causes.length && !effects.length) code = 'graph TB\n    P[Remplissez causes et effets]\n';
    const el = document.getElementById('tree-mermaid');
    el.textContent = code;
    el.removeAttribute('data-processed');
    try { await mermaid.run({ nodes: [el] }); } catch (e) { console.error('Mermaid error:', e); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SMART
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addSmart() {
    if (!current) return;
    const text = document.getElementById('smart-text').value.trim();
    const indicator = document.getElementById('smart-indicator').value.trim();
    const deadline = document.getElementById('smart-deadline').value;
    if (!text) { toast('DÃ©crivez l\'objectif', 'error'); return; }
    current.smart.push({ id: Date.now(), text, indicator, deadline, done: false });
    renderSmart(); scheduleSave(); updatePreview(); updateStats();
    document.getElementById('smart-text').value = '';
    document.getElementById('smart-indicator').value = '';
    document.getElementById('smart-deadline').value = '';
    toast('Objectif ajoutÃ©', 'success');
}

function toggleSmart(id) { if (!current) return; const s = current.smart.find(x => x.id === id); if (s) s.done = !s.done; renderSmart(); scheduleSave(); updatePreview(); }
function removeSmart(id) { if (!current) return; current.smart = current.smart.filter(x => x.id !== id); renderSmart(); scheduleSave(); updatePreview(); updateStats(); }

function renderSmart() {
    if (!current) return;
    const c = document.getElementById('smart-list');
    if (!current.smart.length) { c.innerHTML = '<p style="color:var(--text-muted);text-align:center">Aucun objectif</p>'; return; }
    c.innerHTML = current.smart.map(s => `
        <div class="smart-item">
            <input type="checkbox" class="smart-checkbox" ${s.done ? 'checked' : ''} onchange="toggleSmart(${s.id})">
            <div class="smart-content">
                <div class="smart-text ${s.done ? 'done' : ''}">${esc(s.text)}</div>
                <div class="smart-meta">${s.indicator ? 'ğŸ“Š ' + esc(s.indicator) : ''} ${s.deadline ? 'ğŸ“… ' + s.deadline : ''}</div>
            </div>
            <button class="btn btn-sm btn-secondary" onclick="removeSmart(${s.id})">âœ•</button>
        </div>
    `).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// JOURNAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addJournal() {
    if (!current) return;
    const date = document.getElementById('journal-date').value;
    const type = document.getElementById('journal-type').value;
    const content = document.getElementById('journal-content').value.trim();
    if (!content) { toast('DÃ©crivez l\'entrÃ©e', 'error'); return; }
    current.journal.unshift({ id: Date.now(), date, type, content });
    renderJournal(); scheduleSave(); updatePreview(); updateStats();
    document.getElementById('journal-content').value = '';
    toast('EntrÃ©e ajoutÃ©e', 'success');
}

function removeJournal(id) { if (!current) return; current.journal = current.journal.filter(x => x.id !== id); renderJournal(); scheduleSave(); updatePreview(); updateStats(); }

function renderJournal() {
    if (!current) return;
    const c = document.getElementById('journal-list');
    const icons = { action: 'ğŸ¯', rencontre: 'ğŸ¤', victoire: 'ğŸ†', difficulte: 'âš ï¸', note: 'ğŸ“' };
    if (!current.journal.length) { c.innerHTML = '<p style="color:var(--text-muted);text-align:center">Aucune entrÃ©e</p>'; return; }
    c.innerHTML = current.journal.map(j => `
        <div class="journal-entry">
            <span class="journal-icon">${icons[j.type] || 'ğŸ“'}</span>
            <div class="journal-content">
                <div class="journal-text">${esc(j.content)}</div>
                <div class="journal-date">${j.date}</div>
            </div>
            <button class="btn btn-sm btn-secondary" onclick="removeJournal(${j.id})">âœ•</button>
        </div>
    `).join('');
}

function updateMessagePreview() {
    if (!current) return;
    const m = current.message || {};
    const el = document.getElementById('message-preview');
    if (!m.accroche && !m.probleme && !m.importance && !m.action) {
        el.innerHTML = '<span style="color:var(--text-muted)">Remplissez les champs...</span>';
        return;
    }
    let html = '';
    if (m.accroche) html += `<strong>${esc(m.accroche)}</strong><br><br>`;
    if (m.probleme) html += `${esc(m.probleme)}<br><br>`;
    if (m.importance) html += `<em>${esc(m.importance)}</em><br><br>`;
    if (m.action) html += `<strong>â†’ ${esc(m.action)}</strong>`;
    el.innerHTML = html || '<span style="color:var(--text-muted)">Aucun contenu</span>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PREVIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updatePreview() {
    if (!current) { document.getElementById('preview-doc').innerHTML = '<p style="color:var(--text-muted);text-align:center">Aucun projet</p>'; return; }
    const p = current;
    const f = v => v ? `<p class="filled">${esc(v)}</p>` : '<p class="empty">Non renseignÃ©</p>';
    let h = `<h1>${esc(p.meta?.name || 'Sans nom')}</h1>`;
    h += `<div class="doc-meta">ModifiÃ© le ${new Date(p.modified).toLocaleDateString('fr-FR')}</div>`;
    h += `<h2 class="voir">ğŸ‘ï¸ VOIR</h2>`;
    h += `<h3>ğŸ¯ Vision</h3>${f(p.domino?.vision)}`;
    h += `<h2 class="juger">âš–ï¸ JUGER</h2>`;
    h += `<h3>ğŸŒ³ ProblÃ¨me</h3>${f(p.arbre?.probleme)}`;
    if (p.acteurs?.length) {
        h += '<h3>ğŸ‘¥ Acteurs</h3><p>';
        p.acteurs.forEach(a => h += `<span class="actor-badge ${a.position}">${esc(a.name)}</span>`);
        h += '</p>';
    }
    h += `<h2 class="agir">âœŠ AGIR</h2>`;
    h += `<h3>ğŸ’¬ Message</h3>`;
    if (p.message?.accroche) h += `<p class="filled"><strong>${esc(p.message.accroche)}</strong></p>`;
    if (p.message?.action) h += `<p class="filled"><strong>â†’ ${esc(p.message.action)}</strong></p>`;
    if (!p.message?.accroche && !p.message?.action) h += '<p class="empty">Non renseignÃ©</p>';
    document.getElementById('preview-doc').innerHTML = h;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportJSON() {
    if (!current) return;
    dl(JSON.stringify(current, null, 2), `${slug(current.meta?.name)}.json`, 'application/json');
    toast('Export JSON OK', 'success');
}

function exportMD() {
    if (!current) return;
    const p = current;
    let md = `# ${p.meta?.name || 'Projet'}\n\n---\n\n`;
    md += `## ğŸ‘ï¸ VOIR\n\n### Vision\n${p.domino?.vision || '*â€”*'}\n\n`;
    md += `## âš–ï¸ JUGER\n\n### ProblÃ¨me\n${p.arbre?.probleme || '*â€”*'}\n\n`;
    md += `## âœŠ AGIR\n\n### Message\n${p.message?.accroche ? '**' + p.message.accroche + '**\n\n' : ''}`;
    if (p.message?.action) md += `â†’ **${p.message.action}**\n`;
    dl(md, `${slug(p.meta?.name)}.md`, 'text/markdown');
    toast('Export Markdown OK', 'success');
}

function exportHTML() {
    if (!current) return;
    const p = current;
    let html = `<!DOCTYPE html><html lang="fr"><head><meta charset="UTF-8"><title>${esc(p.meta?.name)}</title><style>body{font-family:system-ui;max-width:800px;margin:2rem auto;padding:0 1rem}h1{color:#1e40af;border-bottom:3px solid #f59e0b;padding-bottom:0.5rem}</style></head><body>`;
    html += `<h1>${esc(p.meta?.name)}</h1>`;
    html += `<h2>Vision</h2><p>${esc(p.domino?.vision) || 'â€”'}</p>`;
    html += `<h2>ProblÃ¨me</h2><p>${esc(p.arbre?.probleme) || 'â€”'}</p>`;
    html += `<h2>Message</h2><p><strong>${esc(p.message?.accroche) || ''}</strong></p>`;
    html += `</body></html>`;
    dl(html, `${slug(p.meta?.name)}.html`, 'text/html');
    toast('Export HTML OK', 'success');
}

function exportPDF() {
    if (!current) { toast('Aucun projet', 'error'); return; }
    if (!LIBS.jspdf()) { toast('BibliothÃ¨que PDF non chargÃ©e', 'error'); return; }
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const p = current;
        doc.setFontSize(18); doc.text(p.meta?.name || 'Projet', 20, 20);
        doc.setFontSize(10); doc.setTextColor(100); doc.text(`ExportÃ© le ${new Date().toLocaleDateString('fr-FR')}`, 20, 28);
        let y = 40;
        const addSection = (title, content) => {
            if (y > 260) { doc.addPage(); y = 20; }
            doc.setFontSize(12); doc.setTextColor(0); doc.text(title, 20, y); y += 7;
            doc.setFontSize(10); doc.setTextColor(60);
            const lines = doc.splitTextToSize(content || 'Non renseignÃ©', 170);
            doc.text(lines, 20, y); y += lines.length * 5 + 8;
        };
        addSection('VISION', p.domino?.vision);
        addSection('PROBLÃˆME', p.arbre?.probleme);
        addSection('MESSAGE', (p.message?.accroche || '') + '\n\nâ†’ ' + (p.message?.action || ''));
        doc.save(`${slug(p.meta?.name)}.pdf`);
        toast('Export PDF OK', 'success');
    } catch (e) {
        console.error('PDF error:', e);
        toast('Erreur PDF: ' + e.message, 'error');
    }
}

function exportDOCX() {
    if (!current) { toast('Aucun projet', 'error'); return; }
    if (!LIBS.docx()) { toast('BibliothÃ¨que DOCX non chargÃ©e', 'error'); return; }
    try {
        const { Document, Paragraph, TextRun, HeadingLevel, Packer } = window.docx;
        const p = current;
        const doc = new Document({
            sections: [{
                children: [
                    new Paragraph({ text: p.meta?.name || 'Projet', heading: HeadingLevel.TITLE }),
                    new Paragraph({ text: '' }),
                    new Paragraph({ text: 'VISION', heading: HeadingLevel.HEADING_1 }),
                    new Paragraph({ text: p.domino?.vision || 'Non renseignÃ©' }),
                    new Paragraph({ text: '' }),
                    new Paragraph({ text: 'PROBLÃˆME', heading: HeadingLevel.HEADING_1 }),
                    new Paragraph({ text: p.arbre?.probleme || 'Non renseignÃ©' }),
                    new Paragraph({ text: '' }),
                    new Paragraph({ text: 'MESSAGE', heading: HeadingLevel.HEADING_1 }),
                    new Paragraph({ children: [new TextRun({ text: p.message?.accroche || '', bold: true })] }),
                    new Paragraph({ children: [new TextRun({ text: 'â†’ ' + (p.message?.action || '') })] })
                ]
            }]
        });
        Packer.toBlob(doc).then(blob => {
            dlBlob(blob, `${slug(p.meta?.name)}.docx`);
            toast('Export Word OK', 'success');
        });
    } catch (e) {
        console.error('DOCX error:', e);
        toast('Erreur DOCX: ' + e.message, 'error');
    }
}

function exportXLSX() {
    if (!current) { toast('Aucun projet', 'error'); return; }
    if (!LIBS.xlsx()) { toast('BibliothÃ¨que Excel non chargÃ©e', 'error'); return; }
    try {
        const p = current;
        const wb = XLSX.utils.book_new();
        const summary = [
            ['Projet Plaidoyer Citoyen'], [''],
            ['Nom', p.meta?.name || ''], ['Description', p.meta?.description || ''],
            [''], ['VOIR'], ['Vision', p.domino?.vision || ''],
            [''], ['JUGER'], ['ProblÃ¨me', p.arbre?.probleme || ''],
            [''], ['AGIR'], ['Message', p.message?.accroche || ''], ['Action', p.message?.action || '']
        ];
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(summary), 'RÃ©sumÃ©');
        if (p.acteurs?.length) {
            const actors = [['Nom', 'RÃ´le', 'Position', 'Pouvoir'], ...p.acteurs.map(a => [a.name, a.role, a.position, a.power])];
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(actors), 'Acteurs');
        }
        if (p.smart?.length) {
            const smart = [['Objectif', 'Indicateur', 'Ã‰chÃ©ance', 'Fait'], ...p.smart.map(s => [s.text, s.indicator, s.deadline, s.done ? 'Oui' : 'Non'])];
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(smart), 'Objectifs');
        }
        if (p.journal?.length) {
            const journal = [['Date', 'Type', 'Contenu'], ...p.journal.map(j => [j.date, j.type, j.content])];
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(journal), 'Journal');
        }
        XLSX.writeFile(wb, `${slug(p.meta?.name)}.xlsx`);
        toast('Export Excel OK', 'success');
    } catch (e) {
        console.error('XLSX error:', e);
        toast('Erreur Excel: ' + e.message, 'error');
    }
}

function importJSON(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async (ev) => {
        try {
            const imported = JSON.parse(ev.target.result);
            imported.id = Date.now().toString();
            imported.modified = new Date().toISOString();
            await dbSave(imported);
            await renderList();
            await selectProject(imported.id);
            toast('Projet importÃ©', 'success');
        } catch (err) {
            console.error('Import error:', err);
            toast('Fichier JSON invalide', 'error');
        }
    };
    reader.readAsText(file);
    e.target.value = '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function esc(s) { return s ? String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>') : ''; }
function slug(s) { return (s || 'projet').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, ''); }
function dl(content, name, type) { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([content], { type })); a.download = name; a.click(); URL.revokeObjectURL(a.href); }
function dlBlob(blob, name) { const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name; a.click(); URL.revokeObjectURL(a.href); }
function toast(msg, type = 'info') {
    const t = document.createElement('div');
    t.className = `toast ${type}`;
    t.innerHTML = `<span>${{ success: 'âœ“', error: 'âœ•', warning: 'âš ', info: 'â„¹' }[type] || 'â„¹'}</span> ${msg}`;
    document.getElementById('toast-container').appendChild(t);
    setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 300); }, 3000);
}
</script>
</body>
</html>
